(()=>{var e={555:(e,t,s)=>{var a=s(178),r={whitespace:/\s+/g,urlHexPairs:/%[\dA-F]{2}/g,quotes:/"/g};function i(e){switch(e){case"%20":return" ";case"%3D":return"=";case"%3A":return":";case"%2F":return"/";default:return e.toLowerCase()}}function n(e){if("string"!=typeof e)throw new TypeError("Expected a string, but received "+typeof e);var t,s;return 65279===e.charCodeAt(0)&&(e=e.slice(1)),"data:image/svg+xml,"+function(e){return encodeURIComponent(e).replace(r.urlHexPairs,i)}((s=e,t=s.trim().replace(r.whitespace," "),Object.keys(a).forEach((e=>{a[e].test(t)&&(t=t.replace(a[e],e))})),t).replace(r.quotes,"'"))}n.toSrcset=function(e){return n(e).replace(/ /g,"%20")},e.exports=n},178:e=>{e.exports={aqua:/#00ffff(ff)?(?!\w)|#0ff(f)?(?!\w)/gi,azure:/#f0ffff(ff)?(?!\w)/gi,beige:/#f5f5dc(ff)?(?!\w)/gi,bisque:/#ffe4c4(ff)?(?!\w)/gi,black:/#000000(ff)?(?!\w)|#000(f)?(?!\w)/gi,blue:/#0000ff(ff)?(?!\w)|#00f(f)?(?!\w)/gi,brown:/#a52a2a(ff)?(?!\w)/gi,coral:/#ff7f50(ff)?(?!\w)/gi,cornsilk:/#fff8dc(ff)?(?!\w)/gi,crimson:/#dc143c(ff)?(?!\w)/gi,cyan:/#00ffff(ff)?(?!\w)|#0ff(f)?(?!\w)/gi,darkblue:/#00008b(ff)?(?!\w)/gi,darkcyan:/#008b8b(ff)?(?!\w)/gi,darkgrey:/#a9a9a9(ff)?(?!\w)/gi,darkred:/#8b0000(ff)?(?!\w)/gi,deeppink:/#ff1493(ff)?(?!\w)/gi,dimgrey:/#696969(ff)?(?!\w)/gi,gold:/#ffd700(ff)?(?!\w)/gi,green:/#008000(ff)?(?!\w)/gi,grey:/#808080(ff)?(?!\w)/gi,honeydew:/#f0fff0(ff)?(?!\w)/gi,hotpink:/#ff69b4(ff)?(?!\w)/gi,indigo:/#4b0082(ff)?(?!\w)/gi,ivory:/#fffff0(ff)?(?!\w)/gi,khaki:/#f0e68c(ff)?(?!\w)/gi,lavender:/#e6e6fa(ff)?(?!\w)/gi,lime:/#00ff00(ff)?(?!\w)|#0f0(f)?(?!\w)/gi,linen:/#faf0e6(ff)?(?!\w)/gi,maroon:/#800000(ff)?(?!\w)/gi,moccasin:/#ffe4b5(ff)?(?!\w)/gi,navy:/#000080(ff)?(?!\w)/gi,oldlace:/#fdf5e6(ff)?(?!\w)/gi,olive:/#808000(ff)?(?!\w)/gi,orange:/#ffa500(ff)?(?!\w)/gi,orchid:/#da70d6(ff)?(?!\w)/gi,peru:/#cd853f(ff)?(?!\w)/gi,pink:/#ffc0cb(ff)?(?!\w)/gi,plum:/#dda0dd(ff)?(?!\w)/gi,purple:/#800080(ff)?(?!\w)/gi,red:/#ff0000(ff)?(?!\w)|#f00(f)?(?!\w)/gi,salmon:/#fa8072(ff)?(?!\w)/gi,seagreen:/#2e8b57(ff)?(?!\w)/gi,seashell:/#fff5ee(ff)?(?!\w)/gi,sienna:/#a0522d(ff)?(?!\w)/gi,silver:/#c0c0c0(ff)?(?!\w)/gi,skyblue:/#87ceeb(ff)?(?!\w)/gi,snow:/#fffafa(ff)?(?!\w)/gi,tan:/#d2b48c(ff)?(?!\w)/gi,teal:/#008080(ff)?(?!\w)/gi,thistle:/#d8bfd8(ff)?(?!\w)/gi,tomato:/#ff6347(ff)?(?!\w)/gi,violet:/#ee82ee(ff)?(?!\w)/gi,wheat:/#f5deb3(ff)?(?!\w)/gi,white:/#ffffff(ff)?(?!\w)|#fff(f)?(?!\w)/gi}}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,s),i.exports}(()=>{"use strict";const e=self.location.pathname===`/${browser.runtime.getManifest().background?.page}`||"/background.loader.js"===self.location.pathname||!1;!function(e){const t=new URL(e);t.origin,t.pathname,t.search}("https://chrome.google.com/webstore/detail/auto-highlight/ndndibnggapaodjdfoeehgmmpppedgfb/");const t="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;const a=()=>Math.floor(Date.now()/864e5);const r=(...e)=>{},i=e=>{throw Error(e)},n=e=>"string"==typeof e,o=e=>(e=>!isNaN(e-parseFloat(e)))(e),c=e=>"function"==typeof e?e():e,l=()=>Date.now(),h=e=>!!e,u=()=>{const e=[];return e.splice(0,0,new Promise(((t,s)=>{e.push(t,s)}))),e};function f(e,t){try{return e()}catch(e){return t?.(e)}}class g{maxConcurrentJobs;options;_work;_runningJobs;_lastRunDoneTime;constructor(e=1,t={}){this.maxConcurrentJobs=e,this.options=t,this._work=this.options.initialWork||[],this._runningJobs=new Set,this._lastRunDoneTime=0}hasFreeSlot(){return this._runningJobs.size<c(this.maxConcurrentJobs)}getRunningJobsCount(){return this._runningJobs.size}getPendingJobsCount(){return this._work.length}async addWork(e,t){return new Promise(((s,a)=>{const r={info:t,fn:()=>{const i=e();i.finally((async()=>{this._runningJobs.delete(r),this.options.afterEach&&await this.options.afterEach(t),i.then(s,a).finally((()=>{Promise.resolve().then((()=>this.startWork())),this._lastRunDoneTime=Date.now()}))}))}};this._work.push(r),this.startWork()}))}async startWork(){if(this.options.minDelayAfterRun&&this._work.length>0){const t=Date.now()-this._lastRunDoneTime;t<this.options.minDelayAfterRun&&await(e=this.options.minDelayAfterRun-t,new Promise((t=>setTimeout(t,e))))}for(var e;this._work.length>0&&this._runningJobs.size<c(this.maxConcurrentJobs)&&(0===this._runningJobs.size||!this.options.canRunWithOthers||this.options.canRunWithOthers(this._work[0].info,[...this._runningJobs].map((e=>e.info))));){const e=this._work.shift();this._runningJobs.add(e),this.options.beforeEach&&await this.options.beforeEach(e.info),e.fn()}}}function d(){0}const{port1:w,port2:m}=new MessageChannel;const p=()=>new Promise((e=>{m.onmessage=()=>e(),w.postMessage(0)}));var b,y;(e=>{e.sync="sync",e.local="local",e.session="session"})(b||(b={})),(e=>{e.loading="loading",e.complete="complete"})(y||(y={}));class _{key;options;_listeners;_listenForChangesFn;storageArea;constructor(e,t={storageArea:"local"}){this.key=e,this.options=t,this._listeners=Array(),this._listenForChangesFn=function(e){let t,s=!1;return(...a)=>s?t:(s=!0,t=e(...a))}((()=>{b[this.storageArea]&&browser.storage[this.storageArea].onChanged.addListener((e=>{e[this.key]&&this._listeners.forEach((t=>t(e[this.key])))}))})),this.storageArea=t.storageArea}async addOnChangeListener(e,{dummyInitValue:t}={}){if(this._listeners.push(e),d(),this._listenForChangesFn(),t){const s=(e=>e instanceof Promise)(t)?await t:t;e({newValue:s,oldValue:s})}}}class A extends _{key;getDefaultValue;options;_updateExecutor;_setExecutor;get legacyStore(){return"localStorage"===this.storageArea?self.localStorage:self.sessionStorage}constructor(e,t,s={storageArea:"local"}){super(e,s),this.key=e,this.getDefaultValue=t,this.options=s,this._updateExecutor=new g,this._setExecutor=new g}async reset(){return this.set(await this.getDefaultValue())}async orDefault(e){return e.hasOwnProperty(this.key)?e[this.key]:await this.getDefaultValue()}async get(){const e="custom"===this.storageArea?await this.options.customDataSource.get()||await this.getDefaultValue():"remote"===this.storageArea?await(await fetch(this.options.remoteApi.url,await this.getRequestInit())).json()||await this.getDefaultValue():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?this.options.localStorageTextOnly?f((()=>this.legacyStore.getItem(this.key)),(()=>""))||await this.getDefaultValue():await f((()=>JSON.parse(this.legacyStore.getItem(this.key)||"")),(()=>this.getDefaultValue())):await browser.storage[this.storageArea].get(this.key).then((e=>this.orDefault(e)));return this.options.onBeforeLoad?await this.options.onBeforeLoad(e):e}async remove(){return"custom"===this.storageArea?await this.options.customDataSource.remove():"remote"===this.storageArea?(await fetch(this.options.remoteApi.url,await this.getRequestInit("DELETE"))).json():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?f((()=>this.legacyStore.removeItem(this.key))):browser.storage[this.storageArea].remove(this.key)}async update(e){return this._updateExecutor.addWork((()=>this.get().then(e).then((e=>this.set(e)))))}async set(e){return this._setExecutor.addWork((async()=>{e=this.options.onBeforeSave?await this.options.onBeforeSave(e):e;const t=await("custom"===this.storageArea?await this.options.customDataSource.set(e):"remote"===this.storageArea?void await fetch(this.options.remoteApi.url,await this.getRequestInit("POST",JSON.stringify(e))):"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?f((()=>this.legacyStore.setItem(this.key,this.options.localStorageTextOnly?String(e):JSON.stringify(e)))):browser.storage[this.storageArea].set({[this.key]:e}));return"session"===this.storageArea&&(await p(),await p(),await p()),t}))}async setWith(e,t){return"remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?i("missing"):browser.storage[this.storageArea].set(Object.assign({[this.key]:e},t))}async getWith(...e){const t=e.map((e=>n(e)?e:e.key)),s="remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?i("missing"):await browser.storage[this.storageArea].get([this.key,...t]),a=await this.orDefault(s),r=e.map((async e=>n(e)?s[e]:await e.orDefault(s)));return[a,...await Promise.all(r)]}async getRequestInit(e="GET",t){const s=await c(this.options.remoteApi.GET_Headers),a=await(this.options.remoteApi.authToken?.());return{method:e,body:t,...s,...a?{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",...s?.headers}}:{}}}}"chrome-extension:"!==self.location.protocol?browser.storage.session={get:e=>browser.runtime.sendMessage({type:"_session_store_get",key:e}),set:e=>browser.runtime.sendMessage({type:"_session_store_set",items:e}),remove:e=>browser.runtime.sendMessage({type:"_session_store_remove",key:e}),clear:()=>Promise.resolve(),onChanged:{addListener:()=>({removeListener:()=>{}}),removeListener:()=>({removeListener:()=>{}}),hasListener:()=>!1}}:e&&browser.runtime.onMessage.addListener((e=>{switch(e.type){case"_session_store_get":return browser.storage.session.get(e.key);case"_session_store_set":return browser.storage.session.set(e.items);case"_session_store_remove":return browser.storage.session.remove(e.key)}}));const R=new A("__install_date",(()=>{}),{storageArea:"sync"});browser.runtime.onInstalled.addListener((async({reason:e})=>{if("install"===e){const e=await R.get();Array.isArray(e)||await R.set([a(),a()])}}));let k=!1;const S=Promise.resolve(!1);let I=!1;S.then((e=>I=!1));async function T(){const[e]=await browser.tabs.query(k?{active:!0}:{active:!0,lastFocusedWindow:!0});return e}async function O(t,s={}){const a=(r=t,Array.isArray(r)?r:[r]);var r;const{cookieStoreId:i,inNewTab:n=!1,nextToCurrent:o=!1,active:c=!1,inNewWindow:l=!1,windowId:h,windowOptions:u={},forceIncognitoWindow:f=!1,stopOpenerTabId:g,_directCall:d}=s,w=l||f;if(!e&&!d)return function(e,t){if(t._directCall)throw Error("infinite loop???");return t._directCall=!0,browser.runtime.sendMessage(new v(e,t))}(a,s);const m={},[p,...b]=a,y=await _(p,0,h);return b.forEach(((e,t)=>_(e,t+1,y.windowId))),y;async function _(e,t,s){if(w)return browser.windows.create({url:e,...u,...m,...f?{incognito:!0}:{}}).then((e=>e?.tabs[0]));if(n||t>0){const r=c&&0===t,i=await T()||{id:void 0,index:void 0},n=(a=i.index,Number.isFinite(a)?i.index+1:void 0),l=!(!k&&!g),h=t=>browser.tabs.create({url:e,...m,windowId:s,active:r,...o?{index:n}:{},...t?{}:{openerTabId:i.id}});return l?await h(l):await h(l).catch((()=>h(!0)))}return await browser.tabs.update({url:e});var a}}class v{links;options;type;constructor(e,t){this.links=e,this.options=t,this.type="openURL"}}e&&browser.runtime.onMessage.addListener((e=>{if("openURL"===e.type)return O(e.links,e.options)}));const D="_ext_started",L=(async()=>{if(!e)return!1;const{[D]:t}=await browser.storage.session.get(D);return!t&&(await browser.storage.session.set({[D]:Date.now()}),!0)})(),E=new Promise((e=>L.then((t=>t&&e()))));const[x,P]=u(),N=(Promise.resolve(),(e,t)=>e?browser.i18n.getMessage(e,t):"");new Map;function C(e,t){return function(e){const t=Object.getOwnPropertyNames(e);for(let s=0;s<t.length;s++)delete e[t[s]]}(e),Object.assign(e,t)}const M=new A("options",(()=>{})),B={FONT_SIZE:18,SIDE_BAR_SIZE:256,DEFAULT_BACKGROUND_COLOR:"#FFFF00FF",DEFAULT_TEXT_COLOR:"#7c0000",DEFAULT_LIST_ON:!0,EXCLUDED_DOMAINS:[],LIST_POSITION:"right",LIST_WIDTH:20,LIST_ITEM_HEIGHT:2,STORAGE_AREA:b.sync},j=async function(e,t){const s=e.storageArea;b[s]&&browser.storage[s].onChanged.addListener((s=>{s[e.key]&&C(t,s[e.key].newValue||{})}));const a=await e.get();return a?(Object.entries(t).filter((([e])=>!a.hasOwnProperty(e))).map((([e,t])=>a[e]=t)).length>0&&await e.set(a),C(t,a||{})):(await e.set(t),t)}(M,B),V=(new A("last_rule_id",(()=>0)),new A("last_selection",(()=>({selection:"",isTemp:!1,allPages:!1,tabId:0})),{storageArea:"session"})),F="_rule_";function W({areaName:e,filter:t,callback:s}){return(a,r)=>{if(e&&e!==r)return;const i=function(e,{filter:t}={}){return Object.fromEntries(Object.entries(e).filter((([e,s])=>!t||t(e,s))).map((([e,t])=>[e,t?.newValue])))}(a,{filter:t});s(i)}}var U;(e=>{e[e.DOMAIN=0]="DOMAIN",e[e.URL=1]="URL",e[e.CONTAINS=2]="CONTAINS",e[e.REGEX=3]="REGEX",e[e.ALL=4]="ALL"})(U||(U={}));function $(e,t=!1){try{const s=new URL(e).hostname;return t&&s.startsWith("www.")?s.substring(4):s}catch(e){return""}}function J(e,t){if(null==e||null==t)return e===t;if(e.constructor!==t.constructor)return!1;if(e instanceof Function)return e===t;if(e instanceof RegExp)return e===t;if(e===t||e.valueOf()===t.valueOf())return!0;if(Array.isArray(e)&&e.length!==t.length)return!1;if(e instanceof Date)return!1;if(!(e instanceof Object&&t instanceof Object))return!1;const s=Object.keys(e);return Object.keys(t).every((e=>-1!==s.indexOf(e)))&&s.every((s=>J(e[s],t[s])))}s(555);const G=e=>browser.runtime.sendMessage(e),z=async(e,t,s)=>browser.tabs.sendMessage(e,t,s);new Set(["svg","path","circle","text"]);const H=r;class q{pageURL;id;disabled;matchesList;temp;name;text;note;matchPages;search;style;_order;_isActive;_isNew;_tabId;_changeBackground;_changeTextColor;_changeFontSize;beingRenamed;newName;hasNote;constructor(e,t,s,a){this.pageURL=t,this.id=l(),this.disabled=!1,this.matchesList=!1,this.temp=!1,this.name="",this.text="",this.matchPages=[],this.search={},this.style={},this._isActive=!1,this._isNew=!1,this._tabId=0,this.beingRenamed=!1,this.newName="",n(e)?(this.text=e,this.temp=!!s,this.matchPages=[{matchType:a?U.ALL:U.DOMAIN,matchValue:$(t,!0)}],this.style={background:B.DEFAULT_BACKGROUND_COLOR},this.search={acrossElements:!0,eachWord:!!this.text&&!this.text.includes("\n")},this.matchesList=!!B.DEFAULT_LIST_ON):Object.assign(this,e),this.note??="",this.hasNote=!!this.note,this._order=this.id,this._changeBackground=!!this.style.background,this._changeTextColor=!!this.style.color,this._changeFontSize=o(this.style.size)}duplicateRule(){const e=this.serializeRule();return e.id=l(),new q(e)}get label(){return this.name||this.text||N("empty rule")}get createDateLabel(){return function(e=Date.now()){const t=new Date(e);return`${t.toLocaleDateString()} ${t.toLocaleTimeString()}`}(this.id)}get isInvalid(){return!(this.text&&this.matchPages.some((e=>e.matchType===U.ALL||e.matchValue)))}get isValid(){return!this.isInvalid}get icon(){return this.disabled?"fa-eye-slash":this.isInvalid?"fa-exclamation-circle":this._isActive?"fa-check-circle":this.temp?"far fa-clock":""}get title(){return this.disabled?N("disabled_rule"):this.isInvalid?N("incomplete_rule"):this._isActive?N("active_on_current_page"):this.temp?N("temporal_rule_helper"):""}get detailsTitle(){return`${this.label}\n${this.note?`${N("label_note")} ${this.note}\n`:""}\n${N("active_on_pages")}\n\t${this.matchPages.map((e=>e.matchValue)).join("\n\t")}`}serializeRule(){this.matchPages.forEach((e=>{if(e.matchType===U.DOMAIN){const t=$(e.matchValue);t&&(e.matchValue=t)}else e.matchType===U.ALL&&(e.matchValue="")})),this._changeBackground||delete this.style.background,this._changeTextColor||delete this.style.color,this._changeFontSize||delete this.style.size,function(e,...t){const s=new Set(t);Object.keys(e).forEach((t=>{s.has(t)||e[t]||delete e[t]}))}(this.style,"size");const e={id:this.id,name:this.name,...this.note?{note:this.note}:{},matchesList:this.matchesList,disabled:this.disabled,temp:this.temp,text:this.text,matchPages:this.matchPages,search:this.search,style:this.style};return t=e,JSON.parse(JSON.stringify(t));var t}async saveRule(){const e=this.serializeRule();await X.saveRule(e)}async deleteRule(e=!1){H("deleting rule",this),e&&await G({type:"createBackup",backupName:N("save_before_remove",[this.label,this.text])}).catch(r),await X.deleteRule(this.id)}compareDomains(e){if(!e)return!1;const t=e=>e.map((e=>`${e.matchType};${e.matchValue}`)).sort().join("");return t(this.matchPages)===t(e.matchPages)}startRenaming(){this.beingRenamed=!0,this.newName=this.label}stopRenaming(){this.beingRenamed=!1}async renameRule(e){this.stopRenaming();const t=e||this.name;this.name!==t&&(this.name=t,await this.saveRule())}static async getActiveRules(e){return new Set(await z(e,{type:"get_active_rules"},{frameId:0}).catch((()=>[])))}}const X=new class{promise=j.then((()=>{}));dataSyncOrder=new A("order",(()=>[]),{storageArea:"sync"});dataLocalOrder=new A("order",(()=>[]),{storageArea:"local"});get DATA_ORDER(){return B.STORAGE_AREA===b.local?this.dataLocalOrder:this.dataSyncOrder}get storeArea(){return B.STORAGE_AREA}async changeStoreArea(e){const t=e===b.local?b.sync:b.local,s=await browser.storage[t].get();delete s[M.key],await this.deleteAllRules(),await browser.storage[e].set(s)}async getRules(){return await this.promise,browser.storage[this.storeArea].get().then((e=>this.extractStoredRules(e)))}async deleteAllRules(){const e=(await this.getRules()).map((e=>F+e.id));await browser.storage[this.storeArea].remove(e)}async getRule(e){return await this.promise,browser.storage[this.storeArea].get(F+e).then((({[F+e]:t})=>new q(t)))}extractStoredRules(e){return Object.entries(e).filter((([e])=>e.startsWith(F))).map((([e,t])=>new q(t)))}async saveRule(e){await this.promise,await browser.storage[this.storeArea].set({[F+e.id]:e}),G({type:"reloadRules"})}async deleteRule(e){await this.promise,await browser.storage[this.storeArea].remove(F+e)}};async function Y(e){return function(e,t,s){const a=((e,t)=>{const s={};if(!e)return s;for(let a=0;a<e.length;a++){const r=e[a];s[r[t]]=r}return s})(e,t);return s.map((e=>{const t=a[e];return delete a[e],t})).filter(h).concat(Object.values(a))}(e,"id",await X.DATA_ORDER.get())}function K(e){return s=`/editor/editor.html#${a=e,encodeURIComponent(JSON.stringify(a))}`,t&&!browser?.runtime?s:browser.runtime.getURL(s);var s,a}function Z(e,t){if(null!=e)return t(e)}const Q=()=>["/browser-polyfill.min.js"];class ee{selection;url;allPages;isTemp;tabId;editorURL;constructor(e,t,s,a,r){this.selection=e,this.url=t,this.allPages=s,this.isTemp=a,this.tabId=r,this.editorURL=K({selection:e,url:t,allPages:s,isTemp:a,tabId:r})}async openInNewTab(){return O(this.editorURL,{active:!0,inNewTab:!0,nextToCurrent:!0})}async openInNewWindow(){await browser.windows.create({url:this.editorURL,type:"popup",state:"normal",width:900,height:600})}async injectToTab(e,t){await browser.scripting.executeScript({target:{tabId:e,frameIds:Z(t,(e=>[e]))},files:[...Q(),"/content_scripts/build_highlighter.js"]})}}if(browser.contextMenus){const e=function(e,t,{maximumDelay:s=0}={}){let a=-1,i=-1,n=r;function o(){a>0&&self.clearTimeout(a),s&&i>0&&self.clearTimeout(i),a=i=-1,n=r}return c.flush=()=>n(),c.cancel=()=>(-1!==a||-1!==i)&&(o(),!0),c;function c(r=t,c=e){if(self.clearTimeout(a),a=-1,!1===c)return;const l=n=()=>{o(),r()};a=self.setTimeout(l,c),s&&i<0&&(i=self.setTimeout(l,s))}}(1e3,te);browser.storage.onChanged.addListener(W({filter:e=>e.startsWith(F)||e===X.DATA_ORDER.key||e===M.key,callback:()=>e()})),browser.runtime.onInstalled.addListener(te),browser.runtime.onStartup.addListener(te)}async function te(){await j;const e=[...["selection_highlight","selection_temp","selection_temp_everywhere","add_to_rule"].map((e=>se(e,N(e,'"%s"'),["selection"],`DISABLE_CM_${e.toUpperCase()}`))),se("page_highlight",N("page_highlight"),["page"],"DISABLE_CM_PAGE")];await browser.contextMenus.removeAll();const t=await Y((await X.getRules()).filter((e=>!e.disabled&&e.isValid)));async function s(e,t){for(const s of t)await browser.contextMenus.create({id:`generated_${e.id}_${s.id}`,title:s.label,contexts:e.contexts,parentId:e.id})}await async function(e,{beforeEach:t=r,afterEach:s=r,ignoreExceptions:a=!1}={}){const i=Array(e.length);for(let r=0;r<e.length;r++){await t(r);const n=e[r],o=await(a?n().then((e=>[e])).catch((e=>[void 0,e||"unknown GSD error"])):n().then((e=>[e])));i[r]=o,await s(r,o)}return i}(e.map((e=>async()=>{if(await e.build())switch(e.id){case"page_highlight":await s(e,t);break;case"add_to_rule":await s(e,t.filter((e=>e.search.eachWord)))}})))}function se(e,t,s,a){return{id:e,optionName:a,contexts:s,build:async(r,i,n)=>!(await j)[a]&&(browser.contextMenus.create({id:r||e,parentId:n,title:i||t,contexts:s}),!0)}}async function ae(e){await browser.scripting.executeScript({target:{tabId:e,allFrames:!0},func:()=>self.getSelection()?.removeAllRanges()}).catch(r)}function re(e,t){const s={},a={},r=n(t);for(let i=0;i<e.length;i++){const n=e[i],o=r?n[r]:t(n);s[o]?a[o].push(n):(a[o]=[n],s[o]=!0)}return a}browser.contextMenus?.onClicked.addListener((async({menuItemId:e,selectionText:t,frameId:s},a)=>{if(!a)throw Error("missing tab data");const r=t?.trim()||"",i=a.id;switch(e){case"add_to_rule":case"page_highlight":break;case"selection_highlight":case"selection_temp":case"selection_temp_everywhere":{const t="selection_temp_everywhere"===e,n=e.includes("_temp");V.set({selection:r,allPages:t,isTemp:n,tabId:i});try{const e="action";await browser[e].openPopup()}catch(e){const o=new ee(r,a.url,t,n,i);await o.injectToTab(i,s)}await ae(i);break}default:{const t=String(e);if(t.startsWith("generated_")){const[e]=t.split("_").slice(-1).map((e=>parseInt(e))),s=await X.getRule(e);if(t.startsWith("generated_page_highlight_"))!function(e,t,s){for(let a=0;a<e.length;a++)if(s(e[a],t))return e;e.push(t)}(s.matchPages,{matchType:U.DOMAIN,matchValue:$(a.url,!0)},J),await s.saveRule(),await async function(e){await browser.scripting.executeScript({target:{tabId:e,allFrames:!0},files:["/content_scripts/page_loaded.js"]})}(i);else if(t.startsWith("generated_add_to_rule_")&&r){const e=new Set(s.text.split("\n").concat(r));s.text=[...e.values()].join("\n"),await s.saveRule()}await ae(i)}}}})),E.then((async()=>{const e=await X.getRules();for(const t of e)t.temp&&await t.deleteRule()})),browser.commands?.onCommand?.addListener((async e=>{"toggle-highlight"===e&&async function(e,t,{onEnabled:s=r,onDisabled:a=r,storageArea:i="local"}){if(!t)throw Error("no name");const n=e[t]=!e[t];await browser.storage[i].set({options:e}),n?s():a()}(B,"IS_DISABLED",{})}));const ie={},ne={},oe=[],ce=[],le=[];browser.storage.onChanged.addListener(W({filter:e=>e.startsWith(F),callback:async e=>{await fe()}}));const he=fe();function splitRulesByNewline(rules){const result=[];for(const rule of rules){if(rule.text&&rule.text.includes("\n")){const keywords=rule.text.split("\n").filter(k=>k.trim());for(const keyword of keywords){result.push({...rule,text:keyword,search:{...rule.search,eachWord:true}})}}else{result.push(rule)}}return result}async function ue(e){await he,await j;const t=$(e,!0);if(B.EXCLUDED_DOMAINS.includes(t))return[];const s=new Set;ie[e]&&ie[e].forEach((e=>s.add(e))),ne[t]&&ne[t].forEach((e=>s.add(e)));for(let t=0;t<oe.length;t++){const a=oe[t];e.includes(a.matchPages[0].matchValue)&&s.add(a)}for(let t=0;t<ce.length;t++){const a=ce[t];e.match(a.matchPages[0].matchValue)&&s.add(a)}return le.forEach((e=>s.add(e))),splitRulesByNewline(Array.from(s))}async function fe(){const e=(await X.getRules()).flatMap((e=>e.matchPages.map((t=>Object.assign({},e,{matchPages:[t]}))))).filter((e=>e.matchPages[0].matchType===U.ALL||e.matchPages[0].matchValue));C(ne,re(e.filter((e=>e.matchPages[0].matchType===U.DOMAIN)),(e=>e.matchPages[0].matchValue))),C(ie,re(e.filter((e=>e.matchPages[0].matchType===U.URL)),(e=>e.matchPages[0].matchValue))),oe.length=0,ce.length=0,le.length=0;for(let t=0;t<e.length;t++){const s=e[t];switch(s.matchPages[0].matchType){case U.ALL:le.push(s);break;case U.CONTAINS:oe.push(s);break;case U.REGEX:try{new RegExp(s.matchPages[0].matchValue),ce.push(s)}catch(e){}}}}async function ge(e,t,s){const a=await ue(s);0!==a.length&&(await async function(e,t){if(await z(e,{type:"ping"},{frameId:t}).catch((()=>!1)))return;const s=await browser.scripting.executeScript({target:{tabId:e,frameIds:Z(t,(e=>[e]))},files:[...Q(),"/content_scripts/auto_highlight_cs.js"]});s.filter((e=>e.error)).forEach(console.error)}(e,t),await z(e,{type:"rules",rules:a},{frameId:t}))}function de(){const e=browser.runtime.getManifest();return`${e.name} ${e.version}`}const we="action";async function me(e,t,s,a){t||e&&(B.DISABLE_BADGE||async function(e,t){await(browser[we].setBadgeText?.({tabId:e,text:t?t.toString():""}))}(e,s),browser[we].setTitle?.({tabId:e,title:`${de()}${s?`\n${N("matches_count")}: ${s}\n\n${a}`:""}`}))}var pe,be;browser[we].setBadgeBackgroundColor?.({color:"#ff6000"}),M.addOnChangeListener((async({newValue:e})=>{if(e?.DISABLE_BADGE){(await browser.tabs.query({})).forEach((e=>browser[we].setBadgeText?.({tabId:e.id,text:""})))}})),(e=>{e.DB_OP_READ_WRITE="readwrite",e.DB_OP_READONLY="readonly"})(pe||(pe={})),(e=>{e.DB_HISTORY="history"})(be||(be={}));const ye=(()=>{const e=new Promise(((e,t)=>{const s=self.indexedDB.open("auto_highlight",1);s.onupgradeneeded=e=>{const a=s.result;a.onerror=a.onabort=e=>t(e),a.objectStoreNames.contains("history")||a.createObjectStore("history",{keyPath:"id",autoIncrement:!1})},s.onerror=e=>t(e),s.onsuccess=()=>{e(s.result)}}));return{promise:e,dbTransactionOperation:async function(e,a,r,...i){return s(await t(e,a),r,...i)},dbTransaction:t,dbOperation:s};async function t(t,s){const a=(await e).transaction([t],s);return a.onerror=a.onabort=e=>{},a.objectStore(t)}async function s(e,t,...s){return new Promise(((a,r)=>{const i=e[t].apply(e,s);i.onerror=e=>{r()},i.onsuccess=()=>{a(i.result)}}))}})();class _e{name;callback;constructor(e,t){this.name=e,this.callback=t,t&&this.addListener(t)}create(e){browser.alarms.create(this.name,e)}createOnStart(e){E.then((()=>this.create(e)))}clear(){return browser.alarms.clear(this.name)}addListener(e){d(),browser.alarms.onAlarm.addListener((t=>t.name===this.name&&e(t)))}now(){this.create({when:Date.now()})}}const Ae=new class{MAX_HISTORY_COUNT=64;delayedSave=new _e("delayed_save",(()=>this.backupData()));constructor(){d(),browser.runtime.onStartup.addListener((()=>this.clearOldHistory())),browser.storage.onChanged.addListener(((e,t)=>{t!==b.session&&this.delayedSave.create({delayInMinutes:1})}))}async backupData(e="auto-backup"){this.delayedSave.clear();const t=await browser.storage[X.storeArea].get(),s={id:l(),name:e,data:t};await ye.dbTransactionOperation(be.DB_HISTORY,pe.DB_OP_READ_WRITE,"put",s)}async getBackups(){return(await ye.dbTransactionOperation(be.DB_HISTORY,pe.DB_OP_READONLY,"getAll")).reverse()}async clearOldHistory(){const e=await ye.dbTransaction(be.DB_HISTORY,pe.DB_OP_READ_WRITE),t=await ye.dbOperation(e,"getAll"),s=t.length-this.MAX_HISTORY_COUNT;for(let a=0;a<s;a++)await ye.dbOperation(e,"delete",t[a].id)}};new A("rate.extension",(()=>({state:"new"})),{storageArea:"local"});browser.runtime.onInstalled.addListener((async({reason:e,previousVersion:t})=>{0})),browser.runtime.onMessage.addListener(((e,t)=>{switch(e.type){case"page_loaded":ge(t.tab.id,t.frameId,e.url);break;case"getRulesInTab":return T().then((e=>ue(e.url)));case"createBackup":return Ae.backupData(e.backupName);case"getBackups":return Ae.getBackups();case"matches_count":me(t.tab?.id,t.frameId,e.matchesCount,e.statInfo);break;case"selfMessage":return t.tab?.id?z(t.tab.id,e.message):G(e.message);case"isRunningInTab":return Promise.resolve(!!t.tab);case"forward_to_current_tab":return T().then((({id:t})=>z(t,e.message)));case"broadcast":return browser.runtime.sendMessage(e.broadcastMessage)}})),async function(){browser.runtime.onUpdateAvailable.addListener((async e=>{})),await j}()})()})();