(()=>{"use strict";const e=self.location.pathname===`/${browser.runtime.getManifest().background?.page}`||"/background.loader.js"===self.location.pathname||!1;const t=()=>"chrome-extension:"!==self.location.protocol;!function(e){const t=new URL(e);t.origin,t.pathname,t.search}("https://chrome.google.com/webstore/detail/auto-highlight/ndndibnggapaodjdfoeehgmmpppedgfb/");const o="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,s=e=>o&&!browser?.runtime?e:browser.runtime.getURL(e);const n=(...e)=>{},i=e=>{throw Error(e)},a=e=>"string"==typeof e,r=e=>"number"==typeof e,c=e=>(e=>!isNaN(e-parseFloat(e)))(e),l=e=>"function"==typeof e?e():e,h=()=>Date.now(),d=e=>new Promise((t=>setTimeout(t,e))),u=()=>{const e=[];return e.splice(0,0,new Promise(((t,o)=>{e.push(t,o)}))),e};function g(e,t){try{return e()}catch(e){return t?.(e)}}class m{maxConcurrentJobs;options;_work;_runningJobs;_lastRunDoneTime;constructor(e=1,t={}){this.maxConcurrentJobs=e,this.options=t,this._work=this.options.initialWork||[],this._runningJobs=new Set,this._lastRunDoneTime=0}hasFreeSlot(){return this._runningJobs.size<l(this.maxConcurrentJobs)}getRunningJobsCount(){return this._runningJobs.size}getPendingJobsCount(){return this._work.length}async addWork(e,t){return new Promise(((o,s)=>{const n={info:t,fn:()=>{const i=e();i.finally((async()=>{this._runningJobs.delete(n),this.options.afterEach&&await this.options.afterEach(t),i.then(o,s).finally((()=>{Promise.resolve().then((()=>this.startWork())),this._lastRunDoneTime=Date.now()}))}))}};this._work.push(n),this.startWork()}))}async startWork(){if(this.options.minDelayAfterRun&&this._work.length>0){const e=Date.now()-this._lastRunDoneTime;e<this.options.minDelayAfterRun&&await d(this.options.minDelayAfterRun-e)}for(;this._work.length>0&&this._runningJobs.size<l(this.maxConcurrentJobs)&&(0===this._runningJobs.size||!this.options.canRunWithOthers||this.options.canRunWithOthers(this._work[0].info,[...this._runningJobs].map((e=>e.info))));){const e=this._work.shift();this._runningJobs.add(e),this.options.beforeEach&&await this.options.beforeEach(e.info),e.fn()}}}const{port1:p,port2:w}=new MessageChannel;const y=()=>new Promise((e=>{w.onmessage=()=>e(),p.postMessage(0)}));var f,b;(e=>{e.sync="sync",e.local="local",e.session="session"})(f||(f={})),(e=>{e.loading="loading",e.complete="complete"})(b||(b={}));class _{key;options;_listeners;_listenForChangesFn;storageArea;constructor(e,t={storageArea:"local"}){this.key=e,this.options=t,this._listeners=Array(),this._listenForChangesFn=function(e){let t,o=!1;return(...s)=>o?t:(o=!0,t=e(...s))}((()=>{f[this.storageArea]&&browser.storage[this.storageArea].onChanged.addListener((e=>{e[this.key]&&this._listeners.forEach((t=>t(e[this.key])))}))})),this.storageArea=t.storageArea}async addOnChangeListener(e,{dummyInitValue:t}={}){if(this._listeners.push(e),this._listenForChangesFn(),t){const o=(e=>e instanceof Promise)(t)?await t:t;e({newValue:o,oldValue:o})}}}class v extends _{key;getDefaultValue;options;_updateExecutor;_setExecutor;get legacyStore(){return"localStorage"===this.storageArea?self.localStorage:self.sessionStorage}constructor(e,t,o={storageArea:"local"}){super(e,o),this.key=e,this.getDefaultValue=t,this.options=o,this._updateExecutor=new m,this._setExecutor=new m}async reset(){return this.set(await this.getDefaultValue())}async orDefault(e){return e.hasOwnProperty(this.key)?e[this.key]:await this.getDefaultValue()}async get(){const e="custom"===this.storageArea?await this.options.customDataSource.get()||await this.getDefaultValue():"remote"===this.storageArea?await(await fetch(this.options.remoteApi.url,await this.getRequestInit())).json()||await this.getDefaultValue():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?this.options.localStorageTextOnly?g((()=>this.legacyStore.getItem(this.key)),(()=>""))||await this.getDefaultValue():await g((()=>JSON.parse(this.legacyStore.getItem(this.key)||"")),(()=>this.getDefaultValue())):await browser.storage[this.storageArea].get(this.key).then((e=>this.orDefault(e)));return this.options.onBeforeLoad?await this.options.onBeforeLoad(e):e}async remove(){return"custom"===this.storageArea?await this.options.customDataSource.remove():"remote"===this.storageArea?(await fetch(this.options.remoteApi.url,await this.getRequestInit("DELETE"))).json():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?g((()=>this.legacyStore.removeItem(this.key))):browser.storage[this.storageArea].remove(this.key)}async update(e){return this._updateExecutor.addWork((()=>this.get().then(e).then((e=>this.set(e)))))}async set(e){return this._setExecutor.addWork((async()=>{e=this.options.onBeforeSave?await this.options.onBeforeSave(e):e;const t=await("custom"===this.storageArea?await this.options.customDataSource.set(e):"remote"===this.storageArea?void await fetch(this.options.remoteApi.url,await this.getRequestInit("POST",JSON.stringify(e))):"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?g((()=>this.legacyStore.setItem(this.key,this.options.localStorageTextOnly?String(e):JSON.stringify(e)))):browser.storage[this.storageArea].set({[this.key]:e}));return"session"===this.storageArea&&(await y(),await y(),await y()),t}))}async setWith(e,t){return"remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?i("missing"):browser.storage[this.storageArea].set(Object.assign({[this.key]:e},t))}async getWith(...e){const t=e.map((e=>a(e)?e:e.key)),o="remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?i("missing"):await browser.storage[this.storageArea].get([this.key,...t]),s=await this.orDefault(o),n=e.map((async e=>a(e)?o[e]:await e.orDefault(o)));return[s,...await Promise.all(n)]}async getRequestInit(e="GET",t){const o=await l(this.options.remoteApi.GET_Headers),s=await(this.options.remoteApi.authToken?.());return{method:e,body:t,...o,...s?{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json",...o?.headers}}:{}}}}function k(e,t){return function(e){const t=Object.getOwnPropertyNames(e);for(let o=0;o<t.length;o++)delete e[t[o]]}(e),Object.assign(e,t)}t()?browser.storage.session={get:e=>browser.runtime.sendMessage({type:"_session_store_get",key:e}),set:e=>browser.runtime.sendMessage({type:"_session_store_set",items:e}),remove:e=>browser.runtime.sendMessage({type:"_session_store_remove",key:e}),clear:()=>Promise.resolve(),onChanged:{addListener:()=>({removeListener:()=>{}}),removeListener:()=>({removeListener:()=>{}}),hasListener:()=>!1}}:e&&browser.runtime.onMessage.addListener((e=>{switch(e.type){case"_session_store_get":return browser.storage.session.get(e.key);case"_session_store_set":return browser.storage.session.set(e.items);case"_session_store_remove":return browser.storage.session.remove(e.key)}}));(async function(e,t){const o=e.storageArea;f[o]&&browser.storage[o].onChanged.addListener((o=>{o[e.key]&&k(t,o[e.key].newValue||{})}));const s=await e.get();s?(Object.entries(t).filter((([e])=>!s.hasOwnProperty(e))).map((([e,t])=>s[e]=t)).length>0&&await e.set(s),k(t,s||{})):await e.set(t)})(new v("options",(()=>{})),{FONT_SIZE:18,SIDE_BAR_SIZE:256,DEFAULT_BACKGROUND_COLOR:"#FFFF00FF",DEFAULT_TEXT_COLOR:"#7c0000",DEFAULT_LIST_ON:!0,EXCLUDED_DOMAINS:[],LIST_POSITION:"right",LIST_WIDTH:20,LIST_ITEM_HEIGHT:2,STORAGE_AREA:f.sync}),new v("last_rule_id",(()=>0));const x=new v("last_selection",(()=>({selection:"",isTemp:!1,allPages:!1,tabId:0})),{storageArea:"session"}),E=o?Promise.resolve():new Promise((e=>"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",(()=>e())))),[A,P]=u(),S=(Promise.resolve(),(e,t)=>e?browser.i18n.getMessage(e,t):"");new Map;const T=2147483647;const I=e=>Array.isArray(e)?e:[e];const C=new Set(["svg","path","circle","text"]);function L(e,t,o){const s=C.has(e)?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);if(t){const e=a(t)?{textContent:t}:t;Object.entries(e).forEach((([t,o])=>{switch(t){case"text":case"textContent":s[t]=o;break;case"handlers":Object.assign(s,e.handlers);break;default:s.setAttribute(t,o)}}))}return o&&I(o).forEach((e=>{e&&s.appendChild(e)})),s}const R=(e,t,o)=>e.style.setProperty(t,o,"important");function O(e="",{important:t=!0,allToInitial:o=!0}={}){if(!o&&!t)return e;const s=e.split(";").filter((e=>e.trim())),n=o?["all: initial",`z-index: ${T}`,"font-family: Verdana, system-ui, sans-serif, Helvetica","font-size: 12px",...s]:s;return(t?n.map((e=>`${e}!important;`)):n).join("")}const D=(e,{rootNode:t=e,USE_PERCENT:o=!1,PERCENT_RATIO:s=100,elementWidth:i,dontMovePredicate:a=n,onMoveStart:c=n,onMoveEnd:l=n,autoLockFrames:h=!1,autoLockFramesContainer:d,keepInWindow:u}={})=>{let g=0,m=0,p=0,w=0,y=!1,f=n;const b=e=>Math.round(e*i/s),_=e=>Math.round(e*s/i),v=(e,t,s)=>o?f(_(e),_(t),s):f(e,t,s);return t.addEventListener("mousedown",(function(e){if(0!==e.button||a(e))return;c(e),y=!0,e.preventDefault(),h&&(o=d||t,o.querySelectorAll("iframe").forEach((e=>R(e,"pointer-events","none"))));var o;g=e.pageX-p,m=e.pageY-w;const s=e=>{w=e.pageY-m,p=e.pageX-g,v(p,w,e)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",(e=>{document.removeEventListener("mousemove",s),y=!1,h&&function(e){e.querySelectorAll("iframe").forEach((e=>e.style.removeProperty("pointer-events")))}(d||t),u&&A(),l(e)}),{once:!0})})),u&&window.addEventListener("resize",(()=>A())),{node:e,getX:x,getY:k,shift:(e,t)=>{p+=e,w+=t,f(p,w)},setCallback:e=>f=e,isMoving:()=>y,setPosition:E,moveToViewport:A};function k(){return o?_(w):w}function x(){return o?_(p):p}function E(e=x(),t=k(),s=!1){o&&(e=b(e),t=b(t));const n=p!==e||w!==t;p=e,w=t,(n||s)&&v(p,w)}function A({pixelsToKeep:t}={}){const{top:o,left:s,bottom:n,right:i,height:a,width:c}=e.getBoundingClientRect();o<0&&E(void 0,0);const l=r(t)?t:r(u)?u:0,h=Math.max(0,c-l),d=Math.max(0,a-l);s<0-h&&E(0-h,void 0),n>window.innerHeight+d&&E(void 0,Math.max(0,window.innerHeight-a+d)),i>window.innerWidth+h&&E(Math.max(0,window.innerWidth-c+h),void 0)}},F=e=>`${e}px`;function M(e,t,{maximumDelay:o=0}={}){let s=-1,i=-1,a=n;function r(){s>0&&self.clearTimeout(s),o&&i>0&&self.clearTimeout(i),s=i=-1,a=n}return c.flush=()=>a(),c.cancel=()=>(-1!==s||-1!==i)&&(r(),!0),c;function c(n=t,c=e){if(self.clearTimeout(s),s=-1,!1===c)return;const l=a=()=>{r(),n()};s=self.setTimeout(l,c),o&&i<0&&(i=self.setTimeout(l,o))}}const N="__modal_window_custom_event";let W=!1;const z=Promise.resolve(!1);let U=!1;z.then((e=>U=!1));let J=!1;(async()=>await z&&await async function(){return 0}()>=79)().then((e=>J=e));const j=(e,t,o)=>Math.max(e,Math.min(t,o||0));function H(e,{width:t=800,height:o=600,draggableStyle:i="",onClose:a=n,appendToBody:r=!0,rememberPositionKey:l="",closableOverlay:h=!0,overlayBackground:u="rgba(0, 0, 0, 0.3)",closeOnOverlayClick:g=!0,closeOnESC:m=!0}){const p={get node(){return e},get overlayNode(){return T},minimize:async function(e){$("0"),E.style.transition="top 550ms",E.classList.add("pointer_all"),E.title=S("label_restore");const t=W.getY();W.setPosition(void 0,window.innerHeight-64),E.addEventListener("mousedown",(o=C=()=>{$("100%"),E.classList.remove("pointer_all"),E.title="",d(250).then((()=>E.style.removeProperty("transition"))),W.setPosition(void 0,t),e?.()},e=>{(e=>{e.preventDefault(),e.stopImmediatePropagation()})(e),o(e)}),{capture:!0,once:!0});var o},maximize:async function(){E.style.transition="top 250ms, left 250ms, width 250ms, height 250ms";W.setPosition(40,40),B.setPosition(window.innerWidth-80,window.innerHeight-80),await d(250),E.style.removeProperty("transition")},closeModal:()=>{T.isConnected&&(T.remove(),a(),((e,t=[])=>{let o;for(;o=e.pop();)o.apply(null,t)})(I),window.removeEventListener("keydown",w))}},w=(y=p.closeModal,e=>{"Escape"===e.key&&y?y(e):"Enter"===e.key&&f?f(e):b&&b(e)});var y,f,b;m&&window.addEventListener("keydown",w);const _=`\nz-index: 20;\nwidth: ${h?"100%":"0"};\nheight: 100%;\nbackground: ${u};\nposition: fixed;\ntop: 0;\nleft: 0;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\n`,k=`\ndisplay: flex;\nflex-direction: column;\nopacity: 0;\ntop: 0;\nleft: 0;\nposition: fixed;\nbackground: transparent;\nbox-shadow: rgba(0, 0, 0, 0.5) 0px 0px 5px;\nwidth: ${t}px;\nheight: ${o}px;\nmin-width: 320px;\nmin-height: 170px;\nmax-width: 100%;\nmax-height: ${J?"calc(100% - 44px)":"100%"};\n/*border: 1px solid rgb(65, 65, 65);*/\n`,x=`\nz-index: 10;\ncursor: move;\nposition: absolute;\nwidth: 100%;\ntop: 0;\nleft: 0;\nheight: 15px;\n${i}\n`;let E;const A=new v(l,(()=>({}))),P=M(500),T=L("div",{"data-modal-overlay":1,style:_,handlers:{onmousedown:e=>{e.target===T&&(T.onclick=e=>{e.target===T&&g&&p.closeModal()})}}},E=L("div",{style:k},[L("div",{style:"\ndisplay: flex;\noverflow: auto;\nwidth: 100%;\nheight: 100%;\n"},e),L("draggable-top",{style:x,"data-draggable-top":0,handlers:{ondblclick:()=>{p.maximize()}}}),L("img",{style:"\nz-index: 10;\ncursor: nw-resize;\nwidth: 10px;\nopacity: 0.2;\npadding: 2px;\nposition: absolute;\nright: 0;\nbottom: 0;\n-moz-user-select: none;\nuser-select: none;\n",src:s("utils/svg/resize-corner.svg"),"data-resize-corner":0})])),I=Array();let C=n;var O;O=e=>{switch(e.type){case"changeOpacity":T.style.opacity=e.opacity;break;case"changeTransparency":T.style.backgroundColor=e.isTransparent?"transparent":u;break;case"changeOverlayCloseOnClick":g=e.value;break;case"maximize":p.maximize();break;case"addOnCloseHandler":I.push(e.callback);break;case"removeOnCloseHandler":((e,t)=>{for(let o=e.length-1;o>=0;o--)e[o]===t&&e.splice(o,1)})(I,e.callback);break;case"close":p.closeModal();break;case"minimize":p.minimize(e.restoreCallback);break;case"restore":C()}},T.addEventListener(N,(e=>O(e.detail))),r&&document.body.appendChild(T);const W=D(E,{autoLockFrames:!0,keepInWindow:250,dontMovePredicate:e=>e.target!==E&&!e.target.hasAttribute("data-draggable-top")});W.setCallback(((e,t,o)=>{R(E,"top",F(t)),R(E,"left",F(e)),l&&P((()=>A.update((({w:o,h:s})=>({x:e,y:t,w:o,h:s})))))}));const z=document.documentElement.clientWidth,U=document.documentElement.clientHeight,[H,V]=[z/2-t/2,U/2-o/2];W.setPosition(j(0,z-t-10,H),j(0,U-o-10,V)),R(E,"opacity","1");const B=function(e,{cornerNode:t=e.querySelector("[data-resize-corner]"),originalWidth:o,originalHeight:s,callback:i=n,autoLockFrames:a=!1}){let r=o,c=s;const l=D(t,a?{autoLockFrames:!0,autoLockFramesContainer:e}:{});return l.setCallback(((t,n,a)=>{r=o+t,c=s+n,R(e,"width",F(r)),R(e,"height",F(c)),i(r,c,a)})),{setPosition:(e,t,n)=>l.setPosition(e-o,t-s,n),getWidth:()=>r,getHeight:()=>c}}(E,{autoLockFrames:!0,originalWidth:t,originalHeight:o,callback:(e,t,o)=>{l&&A.update((({x:o,y:s})=>({w:e,h:t,x:o,y:s})))}});return l&&A.get().then((({x:e,y:t,w:o,h:s})=>{[e,t].every(c)&&W.setPosition(e,t,!0),[o,s].every(c)&&B.setPosition(o,s,!0),W.moveToViewport()})),p;function $(e){["width","height"].forEach((t=>T.style.setProperty(t,e)))}}function V(e){return s(`/editor/editor.html#${t=e,encodeURIComponent(JSON.stringify(t))}`);var t}async function B(){const[e]=await browser.tabs.query(W?{active:!0}:{active:!0,lastFocusedWindow:!0});return e}async function $(t,o={}){const s=I(t);const{cookieStoreId:n,inNewTab:i=!1,nextToCurrent:a=!1,active:r=!1,inNewWindow:c=!1,windowId:l,windowOptions:h={},forceIncognitoWindow:d=!1,stopOpenerTabId:u,_directCall:g}=o,m=c||d;if(!e&&!g)return function(e,t){if(t._directCall)throw Error("infinite loop???");return t._directCall=!0,browser.runtime.sendMessage(new X(e,t))}(s,o);const p={},[w,...y]=s,f=await b(w,0,l);return y.forEach(((e,t)=>b(e,t+1,f.windowId))),f;async function b(e,t,o){if(m)return browser.windows.create({url:e,...h,...p,...d?{incognito:!0}:{}}).then((e=>e?.tabs[0]));if(i||t>0){const n=r&&0===t,i=await B()||{id:void 0,index:void 0},c=(s=i.index,Number.isFinite(s)?i.index+1:void 0),l=!(!W&&!u),h=t=>browser.tabs.create({url:e,...p,windowId:o,active:n,...a?{index:c}:{},...t?{}:{openerTabId:i.id}});return l?await h(l):await h(l).catch((()=>h(!0)))}return await browser.tabs.update({url:e});var s}}class X{links;options;type;constructor(e,t){this.links=e,this.options=t,this.type="openURL"}}function q(e,t){if(null!=e)return t(e)}e&&browser.runtime.onMessage.addListener((e=>{if("openURL"===e.type)return $(e.links,e.options)}));class G{selection;url;allPages;isTemp;tabId;editorURL;constructor(e,t,o,s,n){this.selection=e,this.url=t,this.allPages=o,this.isTemp=s,this.tabId=n,this.editorURL=V({selection:e,url:t,allPages:o,isTemp:s,tabId:n})}async openInNewTab(){return $(this.editorURL,{active:!0,inNewTab:!0,nextToCurrent:!0})}async openInNewWindow(){await browser.windows.create({url:this.editorURL,type:"popup",state:"normal",width:900,height:600})}async injectToTab(e,t){await browser.scripting.executeScript({target:{tabId:e,frameIds:q(t,(e=>[e]))},files:["/browser-polyfill.min.js","/content_scripts/build_highlighter.js"]})}}class K extends G{isPopUp;static CS_IFRAME_PREFIX="_cs_auto_highlight_iframe_";static POPUP_IFRAME_PREFIX="_popup_auto_highlight_iframe_";container;iframeNode;iframeName;constructor(e,o,s,n,i,a){super(o,s,n,i,a),this.isPopUp=e,this.iframeName=(this.isPopUp?K.POPUP_IFRAME_PREFIX:t()?K.CS_IFRAME_PREFIX:"_web_auto_highlight_iframe_")+h(),this.iframeNode=L("iframe",{src:this.editorURL,style:"width: 100%; height: 100%;",name:this.iframeName,frameborder:0,handlers:{onload:()=>this.iframeNode.focus()}}),browser.runtime.onMessage.addListener((e=>{"closeIframe"===e.type&&e.iframeName===this.iframeName&&r.closeModal()}));const r=H(this.iframeNode,{rememberPositionKey:"_main_modal",appendToBody:!1,closableOverlay:!1,draggableStyle:"\nwidth: calc(100% - 244px);\nleft: 64px;\nheight: 56px;"});this.container=L("auto-highlight-modal-jm",{style:O(Y)});this.container.attachShadow({mode:"closed"}).appendChild(r.overlayNode)}async appendToBody(){await E,document.body.appendChild(this.container)}async appendIframeToBody(){await E,document.body.appendChild(this.iframeNode)}static isRunningInContentScript(){return window.name.startsWith(this.CS_IFRAME_PREFIX)}static isRunningInPopUp(){return window.name.startsWith(this.POPUP_IFRAME_PREFIX)}}const Y=`\nposition: fixed;\ndisplay: block;\nz-index: ${T} !important;\n`;!async function(){const{selection:e,isTemp:t,allPages:o,tabId:s}=await x.get();x.reset();const n=new K(!1,e,location.href,o,t,s);await n.appendToBody()}()})();