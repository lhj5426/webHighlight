/*! For license information please see auto_highlight_cs.js.LICENSE.txt */
(()=>{"use strict";const t=self.location.pathname===`/${browser.runtime.getManifest().background?.page}`||"/background.loader.js"===self.location.pathname||!1;const e=()=>"chrome-extension:"!==self.location.protocol;!function(t){const e=new URL(t);e.origin,e.pathname,e.search}("https://chrome.google.com/webstore/detail/auto-highlight/ndndibnggapaodjdfoeehgmmpppedgfb/");const s="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;const r=(...t)=>{},o=t=>{throw Error(t)},n=t=>"string"==typeof t,a=t=>"function"==typeof t?t():t,i=t=>!!t,c=t=>t(),l=t=>new Promise((e=>setTimeout(e,t))),h=()=>{const t=[];return t.splice(0,0,new Promise(((e,s)=>{t.push(e,s)}))),t},u=t=>browser.runtime.sendMessage(t);function d(t,e){try{return t()}catch(t){return e?.(t)}}class p{maxConcurrentJobs;options;_work;_runningJobs;_lastRunDoneTime;constructor(t=1,e={}){this.maxConcurrentJobs=t,this.options=e,this._work=this.options.initialWork||[],this._runningJobs=new Set,this._lastRunDoneTime=0}hasFreeSlot(){return this._runningJobs.size<a(this.maxConcurrentJobs)}getRunningJobsCount(){return this._runningJobs.size}getPendingJobsCount(){return this._work.length}async addWork(t,e){return new Promise(((s,r)=>{const o={info:e,fn:()=>{const n=t();n.finally((async()=>{this._runningJobs.delete(o),this.options.afterEach&&await this.options.afterEach(e),n.then(s,r).finally((()=>{Promise.resolve().then((()=>this.startWork())),this._lastRunDoneTime=Date.now()}))}))}};this._work.push(o),this.startWork()}))}async startWork(){if(this.options.minDelayAfterRun&&this._work.length>0){const t=Date.now()-this._lastRunDoneTime;t<this.options.minDelayAfterRun&&await l(this.options.minDelayAfterRun-t)}for(;this._work.length>0&&this._runningJobs.size<a(this.maxConcurrentJobs)&&(0===this._runningJobs.size||!this.options.canRunWithOthers||this.options.canRunWithOthers(this._work[0].info,[...this._runningJobs].map((t=>t.info))));){const t=this._work.shift();this._runningJobs.add(t),this.options.beforeEach&&await this.options.beforeEach(t.info),t.fn()}}}function m(t){let e,s=!1;return(...r)=>s?e:(s=!0,e=t(...r))}const{port1:g,port2:f}=new MessageChannel;const w=()=>new Promise((t=>{f.onmessage=()=>t(),g.postMessage(0)}));var x,y;(t=>{t.sync="sync",t.local="local",t.session="session"})(x||(x={})),(t=>{t.loading="loading",t.complete="complete"})(y||(y={}));class b{key;options;_listeners;_listenForChangesFn;storageArea;constructor(t,e={storageArea:"local"}){this.key=t,this.options=e,this._listeners=Array(),this._listenForChangesFn=m((()=>{x[this.storageArea]&&browser.storage[this.storageArea].onChanged.addListener((t=>{t[this.key]&&this._listeners.forEach((e=>e(t[this.key])))}))})),this.storageArea=e.storageArea}async addOnChangeListener(t,{dummyInitValue:e}={}){if(this._listeners.push(t),this._listenForChangesFn(),e){const s=(t=>t instanceof Promise)(e)?await e:e;t({newValue:s,oldValue:s})}}}class E extends b{key;getDefaultValue;options;_updateExecutor;_setExecutor;get legacyStore(){return"localStorage"===this.storageArea?self.localStorage:self.sessionStorage}constructor(t,e,s={storageArea:"local"}){super(t,s),this.key=t,this.getDefaultValue=e,this.options=s,this._updateExecutor=new p,this._setExecutor=new p}async reset(){return this.set(await this.getDefaultValue())}async orDefault(t){return t.hasOwnProperty(this.key)?t[this.key]:await this.getDefaultValue()}async get(){const t="custom"===this.storageArea?await this.options.customDataSource.get()||await this.getDefaultValue():"remote"===this.storageArea?await(await fetch(this.options.remoteApi.url,await this.getRequestInit())).json()||await this.getDefaultValue():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?this.options.localStorageTextOnly?d((()=>this.legacyStore.getItem(this.key)),(()=>""))||await this.getDefaultValue():await d((()=>JSON.parse(this.legacyStore.getItem(this.key)||"")),(()=>this.getDefaultValue())):await browser.storage[this.storageArea].get(this.key).then((t=>this.orDefault(t)));return this.options.onBeforeLoad?await this.options.onBeforeLoad(t):t}async remove(){return"custom"===this.storageArea?await this.options.customDataSource.remove():"remote"===this.storageArea?(await fetch(this.options.remoteApi.url,await this.getRequestInit("DELETE"))).json():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?d((()=>this.legacyStore.removeItem(this.key))):browser.storage[this.storageArea].remove(this.key)}async update(t){return this._updateExecutor.addWork((()=>this.get().then(t).then((t=>this.set(t)))))}async set(t){return this._setExecutor.addWork((async()=>{t=this.options.onBeforeSave?await this.options.onBeforeSave(t):t;const e=await("custom"===this.storageArea?await this.options.customDataSource.set(t):"remote"===this.storageArea?void await fetch(this.options.remoteApi.url,await this.getRequestInit("POST",JSON.stringify(t))):"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?d((()=>this.legacyStore.setItem(this.key,this.options.localStorageTextOnly?String(t):JSON.stringify(t)))):browser.storage[this.storageArea].set({[this.key]:t}));return"session"===this.storageArea&&(await w(),await w(),await w()),e}))}async setWith(t,e){return"remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?o("missing"):browser.storage[this.storageArea].set(Object.assign({[this.key]:t},e))}async getWith(...t){const e=t.map((t=>n(t)?t:t.key)),s="remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?o("missing"):await browser.storage[this.storageArea].get([this.key,...e]),r=await this.orDefault(s),a=t.map((async t=>n(t)?s[t]:await t.orDefault(s)));return[r,...await Promise.all(a)]}async getRequestInit(t="GET",e){const s=await a(this.options.remoteApi.GET_Headers),r=await(this.options.remoteApi.authToken?.());return{method:t,body:e,...s,...r?{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json",...s?.headers}}:{}}}}function k(t,e){return function(t){const e=Object.getOwnPropertyNames(t);for(let s=0;s<e.length;s++)delete t[e[s]]}(t),Object.assign(t,e)}e()?browser.storage.session={get:t=>browser.runtime.sendMessage({type:"_session_store_get",key:t}),set:t=>browser.runtime.sendMessage({type:"_session_store_set",items:t}),remove:t=>browser.runtime.sendMessage({type:"_session_store_remove",key:t}),clear:()=>Promise.resolve(),onChanged:{addListener:()=>({removeListener:()=>{}}),removeListener:()=>({removeListener:()=>{}}),hasListener:()=>!1}}:t&&browser.runtime.onMessage.addListener((t=>{switch(t.type){case"_session_store_get":return browser.storage.session.get(t.key);case"_session_store_set":return browser.storage.session.set(t.items);case"_session_store_remove":return browser.storage.session.remove(t.key)}}));const S=new E("options",(()=>{})),T={FONT_SIZE:18,SIDE_BAR_SIZE:256,DEFAULT_BACKGROUND_COLOR:"#FFFF00FF",DEFAULT_TEXT_COLOR:"#7c0000",DEFAULT_LIST_ON:!0,EXCLUDED_DOMAINS:[],LIST_POSITION:"right",LIST_WIDTH:20,LIST_ITEM_HEIGHT:2,STORAGE_AREA:x.sync},A=async function(t,e){const s=t.storageArea;x[s]&&browser.storage[s].onChanged.addListener((s=>{s[t.key]&&k(e,s[t.key].newValue||{})}));const r=await t.get();return r?(Object.entries(e).filter((([t])=>!r.hasOwnProperty(t))).map((([t,e])=>r[t]=e)).length>0&&await t.set(r),k(e,r||{})):(await t.set(e),e)}(S,T),_=(new E("last_rule_id",(()=>0)),new E("last_selection",(()=>({selection:"",isTemp:!1,allPages:!1,tabId:0})),{storageArea:"session"}),t=>parseInt(t.slice("_rule_".length)));const I=s?Promise.resolve():new Promise((t=>"complete"===document.readyState||"interactive"===document.readyState?t():document.addEventListener("DOMContentLoaded",(()=>t()))));function N(t,e,{maximumDelay:s=0}={}){let o=-1,n=-1,a=r;function i(){o>0&&self.clearTimeout(o),s&&n>0&&self.clearTimeout(n),o=n=-1,a=r}return c.flush=()=>a(),c.cancel=()=>(-1!==o||-1!==n)&&(i(),!0),c;function c(r=e,c=t){if(self.clearTimeout(o),o=-1,!1===c)return;const l=a=()=>{i(),r()};o=self.setTimeout(l,c),s&&n<0&&(n=self.setTimeout(l,s))}}const v=t=>{let e=0;for(let s=0;s<t.length;s++)e+=t[s];return e};class O{constructor(t,e){this.ctx=t,this.opt=e,this.attrName="data-markjsListener"}static matches(t,e){if(!e||!e.length)return!1;const s="string"==typeof e?[e]:e,r=t.matches||t.matchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return r&&s.some((e=>!0===r.call(t,e)))}getContexts(){let t,e=!1;this.ctx?this.opt.window.NodeList.prototype.isPrototypeOf(this.ctx)?t=this.ctx:Array.isArray(this.ctx)?(t=this.ctx,e=!0):t="string"==typeof this.ctx?this.opt.window.document.querySelectorAll(this.ctx):[this.ctx]:t=[];const s=[];return t.forEach((t=>{-1!==s.indexOf(t)||s.some((e=>e.contains(t)))||s.push(t)})),e&&s.sort(((t,e)=>(t.compareDocumentPosition(e)&Node.DOCUMENT_POSITION_FOLLOWING)>0?-1:1)),s}getIframeContents(t,e,s){try{const s=t.contentWindow.document;s&&(t.setAttribute(this.attrName,"completed"),e({iframe:t,context:s}))}catch(e){t.setAttribute(this.attrName,"error"),s({iframe:t,error:e})}}isIframeBlank(t){const e="about:blank",s=t.getAttribute("src").trim();return t.contentWindow.location.href===e&&s!==e&&s}observeIframeLoad(t,e,s){if(t.hasAttribute(this.attrName))return;let r=null;const o=()=>{clearTimeout(r),t.removeEventListener("load",o),this.getIframeContents(t,e,s)};t.addEventListener("load",o),t.setAttribute(this.attrName,!0),r=setTimeout(o,this.opt.iframesTimeout)}onIframeReady(t,e,s){try{"complete"===t.contentWindow.document.readyState?this.isIframeBlank(t)?this.observeIframeLoad(t,e,s):this.getIframeContents(t,e,s):this.observeIframeLoad(t,e,s)}catch(t){s(t)}}waitForAllIframes(t,e){let s=0,r=[],o=[],n=!1;const a=setTimeout((()=>{n=!0,e()}),this.opt.iframesTimeout),i=()=>{clearTimeout(a),n||e()},c=()=>{s===r.filter((t=>!this.hasAttributeValue(t,this.attrName,"error"))).length&&i()},l=t=>{t.iframe&&"about:blank"===t.context.location.href||(o=[],t.context.querySelectorAll(t.iframe?"body iframe":"iframe").forEach((t=>{O.matches(t,this.opt.exclude)||(r.push(t),t.hasAttribute(this.attrName)||o.push(t))})),t.iframe||o.length)?o.length?o.forEach((t=>{this.onIframeReady(t,(t=>{s++,l(t)}),(t=>{this.opt.debug,c()}))})):c():i()};l({context:t})}createIterator(t,e,s){return this.opt.window.document.createNodeIterator(t,e,s,!1)}addRemoveStyle(t,e,s){if(s){if(e&&t.firstChild&&!t.querySelector("style[data-markjs]")){const s=this.opt.window.document.createElement("style");s.setAttribute("data-markjs","true"),s.textContent=e,t.insertBefore(s,t.firstChild)}}else{let e=t.querySelector("style[data-markjs]");e&&t.removeChild(e)}}hasAttributeValue(t,e,s){return t.hasAttribute(e)&&t.getAttribute(e)===s}iterateThroughNodes(t,e,s,r,o){const n=this.opt.window.NodeFilter,a=this.opt.shadowDOM,i=this.opt.iframes;if(i||a){const o=0!=(e&n.SHOW_ELEMENT),c=0!=(e&n.SHOW_TEXT);c&&(e=n.SHOW_ELEMENT|n.SHOW_TEXT);const l=t=>{const n=this.createIterator(t,e);for(;t=n.nextNode();)1===t.nodeType?(o&&s(t)&&r(t),i&&"iframe"===t.nodeName.toLowerCase()&&!O.matches(t,this.opt.exclude)&&this.hasAttributeValue(t,this.attrName,"completed")&&this.getIframeContents(t,(t=>{l(t.context)}),(()=>{})),a&&t.shadowRoot&&"open"===t.shadowRoot.mode&&(this.addRemoveStyle(t.shadowRoot,a.style,c),l(t.shadowRoot))):c&&3===t.nodeType&&s(t)&&r(t)};l(t)}else{const o=this.createIterator(t,e,(t=>s(t)?n.FILTER_ACCEPT:n.FILTER_REJECT));let a;for(;a=o.nextNode();)r(a)}o()}forEachNode(t,e,s,r=(()=>{})){const o=this.getContexts();let n=o.length;n||r(),o.forEach((o=>{n--;const a=()=>{this.iterateThroughNodes(o,t,s,e,(()=>{n<=0&&r()}))};this.opt.iframes?this.waitForAllIframes(o,a):a()}))}}class C{constructor(t){this.opt=Object.assign({},{diacritics:!0,synonyms:{},accuracy:"partially",caseSensitive:!1,ignoreJoiners:!1,ignorePunctuation:[],wildcards:"disabled"},t)}create(t,e){const s="g"+(this.opt.caseSensitive?"":"i");t=this.checkWildcardsEscape(t),t=this.createSynonyms(t,s);const r=this.getJoinersPunctuation();r&&(t=this.setupIgnoreJoiners(t)),this.opt.diacritics&&(t=this.createDiacritics(t)),t=t.replace(/\s+/g,"[\\s]+"),r&&(t=this.createJoiners(t,r)),"disabled"!==this.opt.wildcards&&(t=this.createWildcards(t));const o=this.createAccuracy(t);return e?o:new RegExp(`${o.lookbehind}(${o.pattern})${o.lookahead}`,s)}createCombinePattern(t,e){if(!Array.isArray(t)||!t.length)return null;const s=e?"(":"(?:",r=this.create(t[0],!0),o=r.lookbehind,n=r.lookahead;return{lookbehind:o,pattern:this.distinct(t.map((t=>`${s}${this.create(t,!0).pattern})`))).join("|"),lookahead:n}}sortByLength(t){return t.sort(((t,e)=>t.length===e.length?t>e?1:-1:e.length-t.length))}escape(t){return t.replace(/[[\]/{}()*+?.\\^$|]/g,"\\$&")}preprocess(t){return t&&t.length?this.distinct("string"==typeof t?t.split(""):t).join("").replace(/[-^\]\\]/g,"\\$&"):""}distinct(t){const e=[];return t.forEach((t=>{t.trim()&&-1===e.indexOf(t)&&e.push(t)})),e}createSynonyms(t,e){const s=this.opt.synonyms;if(!Object.keys(s).length)return t;for(const r in s)if(s.hasOwnProperty(r)){let o=Array.isArray(s[r])?s[r]:[s[r]];if(o.unshift(r),o=this.sortByLength(this.distinct(o)).map((t=>this.checkWildcardsEscape(t))),o.length>1){const s=o.map((t=>this.escape(t))).join("|");t=t.replace(new RegExp(s,e),`(?:${o.join("|")})`)}}return t}checkWildcardsEscape(t){return"disabled"!==this.opt.wildcards&&(t=t.replace(/(\\)*\?/g,((t,e)=>e?"?":"")).replace(/(\\)*\*/g,((t,e)=>e?"*":""))),this.escape(t)}createWildcards(t){const e="withSpaces"===this.opt.wildcards,s=e&&this.opt.acrossElements&&this.opt.blockElementsBoundary,r=`[^${s?s.char?s.char.charAt(0):"":""}]*?`;return t.replace(/\x01/g,e?"[^]?":"\\S?").replace(/\x02/g,e?r:"\\S*")}setupIgnoreJoiners(t){return t.replace(/(\(\?:|\|)|\\?.(?=([|)]|$)|.)/g,((t,e,s)=>e||void 0!==s?t:t+"\0"))}createJoiners(t,e){return t.split(/\x00+/).join(`[${e}]*`)}getJoinersPunctuation(){let t=this.preprocess(this.opt.ignorePunctuation),e=t||"";return this.opt.ignoreJoiners&&(e+="\\u00ad\\u200b\\u200c\\u200d"),e}createDiacritics(t){const e=this.opt.caseSensitive,s=["aàáảãạăằắẳẵặâầấẩẫậäåāą","AÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćč","CÇĆČ","dđď","DĐĎ","eèéẻẽẹêềếểễệëěēę","EÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïī","IÌÍỈĨỊÎÏĪ","lł","LŁ","nñňń","NÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøōő","OÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌŐ","rř","RŘ","sšśșş","SŠŚȘŞ","tťțţ","TŤȚŢ","uùúủũụưừứửữựûüůūű","UÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪŰ","yýỳỷỹỵÿ","YÝỲỶỸỴŸ","zžżź","ZŽŻŹ"];return t.split("").map((t=>{for(let r=0;r<s.length;r+=2)if(e){if(-1!==s[r].indexOf(t))return"["+s[r]+"]";if(-1!==s[r+1].indexOf(t))return"["+s[r+1]+"]"}else if(-1!==s[r].indexOf(t)||-1!==s[r+1].indexOf(t))return"["+s[r]+s[r+1]+"]";return t})).join("")}createAccuracy(t){let e,s=this.opt.accuracy,r="()",o=t,n="";if("string"!=typeof s&&(e=this.preprocess(s.limiters),s=s.value),"exactly"===s){const t=e?"[\\s"+e+"]":"\\s";r=`(^|${t})`,n=`(?=$|${t})`}else{const n=e||"!\"#$%&'()*+,\\-./:;<=>?@[\\]\\\\^_`{|}~¡¿",a=`[^\\s${n}]*`;"complementary"===s?o=a+t+a:"startsWith"===s&&(r=`(^|[\\s${n}])`,o=t.replace(/\[\\s\]\+/g,a+"$&")+a)}return{lookbehind:r,pattern:o,lookahead:n}}}class L{constructor(t){this.ctx=t,this.nodeNames=["script","style","title","head","html"]}set opt(t){if(!(t&&t.window&&t.window.document)&&"undefined"==typeof window)throw new Error("Mark.js: please provide a window object as an option.");const e=t&&t.window||window;this._opt=Object.assign({},{window:e,element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,acrossElements:!1,ignoreGroups:0,each:()=>{},noMatch:()=>{},filter:()=>!0,done:()=>{},debug:!1,log:e.console},t)}get opt(){return this._opt}get empty(){return this._empty||(this._empty=this.opt.window.document.createTextNode("")),this._empty}get iterator(){return new O(this.ctx,this.opt)}log(t,e="debug"){if(!this.opt.debug)return;const s=this.opt.log;"object"==typeof s&&"function"==typeof s[e]&&s[e](`mark.js: ${t}`)}report(t){t.forEach((t=>{this.log(`${t.text} ${JSON.stringify(t.obj)}`,t.level?t.level:"debug"),t.skip||this.opt.noMatch(t.obj)}))}checkOption(t,e){this.opt=t;let s=this.cacheDict,r=!0;s&&(!e&&this.opt.cacheTextNodes&&(this.opt.acrossElements?"across"===s.type&&(r=!1):"every"===s.type&&(r=!1)),r&&(this.cacheDict=null))}getSeachTerms(t){const e=this.isString(t)?[t]:t,s=this.opt.separateWordSearch,r=[],o=t=>{t.split(/\n+/).forEach((t=>n(t)))},n=t=>{t.trim()&&-1===r.indexOf(t)&&r.push(t)};return e.forEach((t=>{s?"preserveTerms"===s?t.split(/"("*[^"]+"*)"/).forEach(((t,e)=>{e%2>0?n(t):o(t)})):o(t):n(t)})),r.sort(((t,e)=>e.length-t.length)),r}isNumeric(t){return Number(parseFloat(t))==t}isString(t){return"string"==typeof t}isObject(t){return"[object Object]"===String(t)}isArrayOfObjects(t){return Array.isArray(t)&&t.some((t=>this.isObject(t)))}checkRanges(t,e,s,r){const o="error",n=t.filter((t=>!!(this.isNumeric(t.start)&&this.isNumeric(t.length)&&(t.start=parseInt(t.start),t.length=parseInt(t.length),t.start>=s&&t.start<r&&t.length>0))||(e.push({text:"Invalid range: ",obj:t,level:o}),!1))).sort(((t,e)=>t.start-e.start));if(this.opt.wrapAllRanges)return n;let a,i=0;return n.filter((t=>(a=t.start+t.length,t.start>=i?(i=a,!0):(e.push({text:(a<i?"Nest":"Overlapp")+"ing range: ",obj:t,level:o}),!1))))}setType(t,e){const s=Array.isArray(e.tagNames)&&e.tagNames.length;if(s&&e.tagNames.forEach((e=>t[e.toLowerCase()]=2)),!s||e.extend)for(const e in t)t[e]=2;t.br=3}getTextNodesAcross(t){if(this.opt.cacheTextNodes&&this.cacheDict)return this.cacheDict.lastIndex=0,this.cacheDict.lastTextIndex=0,void t(this.cacheDict);const e={div:1,p:1,li:1,td:1,tr:1,th:1,ul:1,ol:1,dd:1,dl:1,dt:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,blockquote:1,figcaption:1,figure:1,pre:1,table:1,thead:1,tbody:1,tfoot:1,input:1,img:1,nav:1,details:1,label:1,form:1,select:1,menu:1,br:3,menuitem:1,main:1,section:1,article:1,aside:1,picture:1,output:1,button:1,header:1,footer:1,address:1,area:1,canvas:1,map:1,fieldset:1,textarea:1,track:1,video:1,audio:1,body:1,iframe:1,meter:1,object:1,svg:1},s=[],r=this.opt.blockElementsBoundary,o=r?2:1;let n,a,i,c="";r&&(this.setType(e,r),r.char&&(c=r.char.charAt(0)));const l={text:"",regex:/\s/,tags:e,boundary:r,startOffset:0,br:"",ch:c};this.iterator.forEachNode(this.opt.window.NodeFilter.SHOW_ELEMENT|this.opt.window.NodeFilter.SHOW_TEXT,(t=>{i&&s.push(this.getNodeInfo(i,t,a,l)),a=null,i=t}),(t=>1===t.nodeType?(n=e[t.nodeName.toLowerCase()],3===n&&(l.br+="\n"),a&&n!==o||(a=n),!1):!this.excludeElements(t.parentNode)),(()=>{i&&s.push(this.getNodeInfo(i,i,a,l)),t(this.createDict(l.text,s,"across"))}))}getNodeInfo(t,e,s,r){let o=0,n=r.startOffset,a=t.textContent,i="";if(t!==e){const o=r.regex.test(e.textContent[0]),n=o&&r.regex.test(a[a.length-1]);if(r.boundary||!n){let a=s;if(!s){let o=t.parentNode;for(;o;){if(s=r.tags[o.nodeName.toLowerCase()]){a=!(o===e.parentNode||o.contains(e));break}o=o.parentNode}}a&&(n?2===s&&(i=n?r.ch:o?" "+r.ch:r.ch+" "):i=1===s?" ":2===s?" "+r.ch+" ":"")}}return""!==r.br&&(i+=r.br,r.br=""),""!==i&&(a+=i,o=i.length,r.startOffset-=o),this.createInfo(t,r.text.length,(r.text+=a).length-o,o,n)}getTextNodes(t){if(this.opt.cacheTextNodes&&this.cacheDict)return void t(this.cacheDict);const e=[],s=/\n/g,r=[0],o=this.opt.markLines;let n,a="",i=0,c=this.opt.window.NodeFilter.SHOW_TEXT;c=o?this.opt.window.NodeFilter.SHOW_ELEMENT|c:c,this.iterator.forEachNode(c,(t=>{if(o)for(;null!==(n=s.exec(t.textContent));)r.push(i+n.index);a+=t.textContent,e.push({start:i,end:i=a.length,offset:0,node:t})}),(t=>o&&1===t.nodeType?("br"===t.tagName.toLowerCase()&&r.push(i),!1):!this.excludeElements(t.parentNode)),(()=>{const s=this.createDict(a,e,"every");o&&(r.push(i),s.newLines=r),t(s)}))}createDict(t,e,s){const r={text:t,nodes:e,lastIndex:0,lastTextIndex:0};return this.opt.cacheTextNodes&&(this.cacheDict=r,this.cacheDict.type=s),r}excludeElements(t){return-1!==this.nodeNames.indexOf(t.nodeName.toLowerCase())||O.matches(t,this.opt.exclude)}wrapRangeInsert(t,e,s,r,o,n){const a=r===e.node.textContent.length;let i,c=1,l=this.empty;if(0===s){if(a){const t=this.wrapTextNode(e.node);return e.node=t.childNodes[0],{markNode:t,nodeInfo:this.createInfo(l,e.end,e.end,e.offset,0),increment:0}}l=e.node.splitText(r),i=e.node}else a?(i=e.node.splitText(s),c=2):(i=e.node.splitText(s),l=i.splitText(r-s),c=3);const h=this.wrapTextNode(i),u=this.createInfo(h.childNodes[0],1===c?e.start:o,e.start+r,0,e.startOffset),d=this.createInfo(l,2===c?e.end:e.start+r,e.end,e.offset,e.startOffset);return 1===c?t.nodes.splice(n,1,u,d):(2===c?t.nodes.splice(n+1,0,u):t.nodes.splice(n+1,0,u,d),e.end=o,e.offset=0),{markNode:h,nodeInfo:d,increment:c<3?1:2}}createInfo(t,e,s,r,o){return{node:t,start:e,end:s,offset:r,startOffset:o}}wrapTextNode(t){const e=this.opt.element?this.opt.element:"mark";let s=this.opt.window.document.createElement(e);return s.setAttribute("data-markjs","true"),this.opt.className&&s.setAttribute("class",this.opt.className),s.textContent=t.textContent,t.parentNode.replaceChild(s,t),s}wrapRange(t,e,s,r){let o=this.empty,n=s===t.textContent.length,a=t;return 0===e?n||(o=t.splitText(s)):n?a=t.splitText(e):(a=t.splitText(e),o=a.splitText(s-e)),r(this.wrapTextNode(a)),o}wrapRangeAcross(t,e,s,r,o){let n=t.lastIndex,a=!0;const i=this.opt.wrapAllRanges||this.opt.cacheTextNodes;if(i)for(;n>0&&t.nodes[n].start>e;)n--;else if(e<t.lastTextIndex)return;for(;n<t.nodes.length;n++)if(n+1===t.nodes.length||t.nodes[n+1].start>e){let c=t.nodes[n];if(!r(c)){n>t.lastIndex&&(t.lastIndex=n);break}const l=e-c.start,h=(s>c.end?c.end:s)-c.start;if(l>=0&&h>l){if(i){const s=this.wrapRangeInsert(t,c,l,h,e,n);c=s.nodeInfo,o(s.markNode,a)}else c.node=this.wrapRange(c.node,l,h,(t=>{o(t,a)})),c.start+=h,t.lastTextIndex=c.start;a=!1}if(!(s>c.end)){t.lastIndex=n;break}e=c.end+c.offset}}wrapGroups(t,e,s,r,o){let n,a,i,c=e.index,l=-1,h=!1;for(;++l<s.groups.length;)n=s.groups[l],a=e[n],a&&(i=t.textContent.indexOf(a,c),-1!==i&&(r(t,a,n)?(t=this.wrapRange(t,i,i+a.length,(t=>{o(t,n)})),c=0,h=!0):c=i+a.length));return h&&(s.regex.lastIndex=0),t}wrapGroupsAcross(t,e,s,r,o){let n,a,i,c=0,l=0;const h=e.index,u=e[0],d=(e,s)=>{this.wrapRangeAcross(t,e,s,(t=>r(t,u,l)),((t,e)=>{o(t,e,l)}))};this.opt.wrapAllRanges&&d(h,h+u.length);for(let t=0;t<s.groups.length;t++)l=s.groups[t],n=e[l],n&&(a=u.indexOf(n,c),-1!==a&&(i=a+n.length,d(h+a,h+i),c=i))}wrapGroupsDFlag(t,e,s,r,o){let n,a,i=0,c=0,l=0,h=!1,u=0;for(;++l<e.length;)n=e[l],n&&(a=e.indices[l][0],a>=i&&(u=e.indices[l][1],r(t,n,l)&&(t=this.wrapRange(t,a-c,u-c,(t=>{o(t,l)})),u>i&&(i=u),c=u,h=!0)));return h?s.regex.lastIndex=0:0===e[0].length&&this.setLastIndex(s.regex,u),t}wrapGroupsDFlagAcross(t,e,s,r,o){let n,a,i,c=0,l=0,h=0;for(;++l<e.length;)n=e[l],n&&(a=e.indices[l][0],(this.opt.wrapAllRanges||a>=c)&&(h=e.indices[l][1],i=!1,this.wrapRangeAcross(t,a,h,(t=>r(t,n,l)),((t,e)=>{i=!0,o(t,e,l)})),i&&h>c&&(c=h)));0===e[0].length&&this.setLastIndex(s.regex,h)}setLastIndex(t,e){const s=t.lastIndex;t.lastIndex=e>s?e:e>0?s+1:Infinity}collectRegexGroupIndexes(t){let e=[],s=[],r=-1,o=1,n=0,a=!1,i=t.source,c=/^\(\?<(?![=!])|^\((?!\?)/;for(;++r<i.length;)switch(i[r]){case"(":a||(c.test(i.substring(r))?(s.push(1),0===n&&e.push(o),n++,o++):s.push(0));break;case")":a||1!==s.pop()||n--;break;case"\\":r++;break;case"[":a=!0;break;case"]":a=!1}return e}wrapSeparateGroups(t,e,s,r,o){const n=t.hasIndices,a=n?"wrapGroupsDFlag":"wrapGroups",i={regex:t,groups:n?{}:this.collectRegexGroupIndexes(t)},c={abort:!1},l={execution:c};let h,u,d,p,m=0;this.getTextNodes((e=>{e.nodes.every((e=>{for(h=e.node,l.offset=e.start;null!==(u=t.exec(h.textContent))&&(n||""!==u[0])&&(l.match=u,d=p=!0,h=this[a](h,u,i,((t,e,r)=>(l.matchStart=d,l.groupIndex=r,d=!1,s(t,e,l))),((t,e)=>{p&&m++,r(t,{match:u,matchStart:p,count:m,groupIndex:e}),p=!1})),!c.abort););return!c.abort})),o(m)}))}wrapSeparateGroupsAcross(t,e,s,r,o){const n=t.hasIndices,a=n?"wrapGroupsDFlagAcross":"wrapGroupsAcross",i={regex:t,groups:n?{}:this.collectRegexGroupIndexes(t)},c={abort:!1},l={execution:c};let h,u,d,p=0;this.getTextNodesAcross((e=>{for(;null!==(h=t.exec(e.text))&&(n||""!==h[0])&&(l.match=h,u=d=!0,this[a](e,h,i,((t,e,r)=>(l.matchStart=u,l.groupIndex=r,l.offset=t.startOffset,u=!1,s(t.node,e,l))),((t,e,s)=>{d&&p++,r(t,{match:h,matchStart:d,count:p,groupIndex:s,groupStart:e}),d=!1})),!c.abort););o(p)}))}wrapMatches(t,e,s,r,o){const n=0===e?0:e+1,a={abort:!1},i={execution:a};let c,l,h,u,d=0;this.getTextNodes((e=>{for(let o=0;o<e.nodes.length;o++){for(c=e.nodes[o],l=c.node;null!==(h=t.exec(l.textContent))&&""!==(u=h[n]);){if(i.match=h,i.offset=c.start,!s(l,u,i)||!u)continue;let p=0,m=h.index;for(;++p<n;)h[p]&&(m+=h[p].length);const g=m+u.length;if(this.opt.cacheTextNodes){const t=this.wrapRangeInsert(e,c,m,g,c.start+m,o);if(r(t.markNode,{match:h,count:++d}),0===t.increment)break;o+=t.increment,c=t.nodeInfo,l=c.node}else l=this.wrapRange(l,m,g,(t=>{r(t,{match:h,count:++d})}));if(t.lastIndex=0,a.abort)break}if(a.abort)break}o(d)}))}wrapMatchesAcross(t,e,s,r,o){const n=0===e?0:e+1,a={abort:!1},i={execution:a};let c,l,h,u=0;this.getTextNodesAcross((e=>{for(;null!==(c=t.exec(e.text))&&""!==(l=c[n]);){i.match=c,h=!0;let t=0,o=c.index;for(;++t<n;)c[t]&&(o+=c[t].length);if(this.wrapRangeAcross(e,o,o+(l?l.length:0),(t=>(i.matchStart=h,i.offset=t.startOffset,h=!1,s(t.node,l,i))),((t,e)=>{e&&u++,r(t,{match:c,matchStart:e,count:u})})),a.abort)break}o(u)}))}wrapRanges(t,e,s,r){const o=this.opt.markLines,n=[],a=[],i="warn";let c=0;this.getTextNodes((l=>{const h=o?l.newLines.length:l.text.length,u=this.checkRanges(t,n,o?1:0,h);u.forEach(((t,r)=>{let u=t.start,d=u+t.length;d>h&&(n.push({text:`Range was limited to: ${h}`,obj:t,skip:!0,level:i}),d=h),o&&(u=l.newLines[u-1],"\n"===l.text[u]&&u++,d=l.newLines[d-1]);const p=l.text.substring(u,d);p.trim()?this.wrapRangeAcross(l,u,d,(s=>e(s.node,t,p,r)),((e,r)=>{r&&c++,s(e,t,{matchStart:r,count:c})})):(n.push({text:"Skipping whitespace only range: ",obj:t,level:i}),a.push(t))})),this.log(`Valid ranges: ${JSON.stringify(u.filter((t=>-1===a.indexOf(t))))}`),r(c,n)}))}unwrapMatches(t){const e=t.parentNode,s=t.firstChild;if(1===t.childNodes.length)if(3===s.nodeType){const r=t.previousSibling,o=t.nextSibling;if(r&&3===r.nodeType)o&&3===o.nodeType?(r.nodeValue+=s.nodeValue+o.nodeValue,e.removeChild(o)):r.nodeValue+=s.nodeValue;else{if(!o||3!==o.nodeType)return void e.replaceChild(t.firstChild,t);o.nodeValue=s.nodeValue+o.nodeValue}e.removeChild(t)}else e.replaceChild(t.firstChild,t);else{if(s){let s=this.opt.window.document.createDocumentFragment();for(;t.firstChild;)s.appendChild(t.removeChild(t.firstChild));e.replaceChild(s,t)}else e.removeChild(t);e.normalize()}}markRegExp(t,e){this.checkOption(e);let s=0,r=0,o=this.opt.separateGroups?"wrapSeparateGroups":"wrapMatches";if(this.opt.acrossElements&&(o=this.opt.separateGroups?"wrapSeparateGroupsAcross":"wrapMatchesAcross",!t.global&&!t.sticky)){let e=t.toString().split("/");t=new RegExp(t.source,"g"+e[e.length-1]),this.log("RegExp is recompiled because it must have g flag")}this.log(`Searching with expression "${t}"`),this[o](t,this.opt.ignoreGroups,((t,e,s)=>this.opt.filter(t,e,r,s)),((t,e)=>{r=e.count,s++,this.opt.each(t,e)}),(e=>{0===e&&this.opt.noMatch(t),this.opt.done(s,e)}))}mark(t,e){if(this.checkOption(e),this.opt.combinePatterns)return void this.markCombinePatterns(t);let s=0,r=0,o=0,n=0;const a=new C(this.opt),i=this.opt.acrossElements?"wrapMatchesAcross":"wrapMatches",c={},l=this.getSeachTerms(t),h=t=>{const e=a.create(t);let u=0;this.log(`Searching with expression "${e}"`),this[i](e,1,((e,s,r)=>(o=n+u,this.opt.filter(e,t,o,u,r))),((t,e)=>{u=e.count,r++,this.opt.each(t,e)}),(e=>{n+=e,0===e&&this.opt.noMatch(t),c[t]=e,++s<l.length?h(l[s]):this.opt.done(r,n,c)}))};l.length?h(l[s]):this.opt.done(0,0,c)}markCombinePatterns(t){let e,s,r=0,o=0,n=0,a=[],i=[];const c=this.opt.acrossElements,l=c?"wrapMatchesAcross":"wrapMatches",h="g"+(this.opt.caseSensitive?"":"i"),u={},d=this.getSeachTerms(t),p=t=>{const d=new RegExp(t,h),m=i[r];this.log(`Searching with expression "${d}"`),this[l](d,1,((t,r,o)=>(c?o.matchStart&&(e=this.getCurrentTerm(o.match,m)):e=this.getCurrentTerm(o.match,m),s=u[e],this.opt.filter(t,e,n+s,s,o))),((t,s)=>{o++,c?s.matchStart&&(u[e]+=1):u[e]+=1,this.opt.each(t,s)}),(t=>{n+=t;const e=m.filter((t=>0===u[t]));e.length&&this.opt.noMatch(e),++r<a.length?p(a[r]):this.opt.done(o,n,u)}))};if(d.length){d.forEach((t=>u[t]=0));const t=this.getPatterns(d);i=t.termsParts,a=t.patterns,p(a[r])}else this.opt.done(0,0,u)}getCurrentTerm(t,e){let s=t.length;for(;--s>2;)if(t[s])return e[s-3];return" "}getPatterns(t){const e=new C(this.opt),s=e.create(t[0],!0),r=this.opt.combinePatterns,o=[],n=[];let a,i=10;Infinity===r?i=Math.pow(2,31):this.isNumeric(r)&&(a=parseInt(r))>0&&(i=a);let c=Math.ceil(t.length/i);for(let r=0;r<c;r++){const a=[],c=Math.min(r*i+i,t.length);for(let e=r*i;e<c;e++)a.push(t[e]);let l=`${s.lookbehind}(${e.createCombinePattern(a,!0).pattern})${s.lookahead}`;o.push(l),n.push(a)}return{patterns:o,termsParts:n}}markRanges(t,e){if(this.checkOption(e,!0),this.isArrayOfObjects(t)){let e=0;this.wrapRanges(t,((t,e,s,r)=>this.opt.filter(t,e,s,r)),((t,s,r)=>{e++,this.opt.each(t,s,r)}),((t,s)=>{this.report(s),this.opt.done(e,t)}))}else this.report([{text:"markRanges() accept an array of objects: ",obj:t,level:"error"}]),this.opt.done(0,0)}unmark(t){this.checkOption(t,!0);let e=(this.opt.element?this.opt.element:"mark")+"[data-markjs]";this.opt.className&&(e+=`.${this.opt.className}`),this.log(`Removal selector "${e}"`),this.iterator.forEachNode(this.opt.window.NodeFilter.SHOW_ELEMENT,(t=>{this.unwrapMatches(t)}),(t=>O.matches(t,e)&&!this.excludeElements(t)),this.opt.done)}}function R(t){const e=new L(t);return this.mark=(t,s)=>(e.mark(t,s),this),this.markRegExp=(t,s)=>(e.markRegExp(t,s),this),this.markRanges=(t,s)=>(e.markRanges(t,s),this),this.unmark=t=>(e.unmark(t),this),this.getVersion=()=>"2.3.0",this}const D=N(200,(()=>{u({type:"matches_count",matchesCount:P.totalCount(),statInfo:P.statistics()})}),{maximumDelay:500}),M={cacheTextNodes:!0,wrapAllRanges:!0};class P{rule;static _rules=new Map;exclude;static ELEMENT_PREFIX="AH_EL_JM_";static executor=new p(1,{beforeEach:()=>P.beforeHandlers.forEach(c),afterEach:()=>P.afterHandlers.forEach(c)});static beforeHandlers=[];static afterHandlers=[];static markPromise=Promise.all([I]).then((()=>new R(document.body)));style;elementName;matchesCount;get ruleId(){return this.rule.id}get hasSideList(){return this.rule.matchesList}get ruleStyle(){return this.rule.style}get lowerText(){return this.rule.text.toLowerCase()}constructor(t){this.rule=t,this.exclude=["textarea"],this.matchesCount=0,this.elementName=P.ELEMENT_PREFIX+t.id,this.updateRule(t),P._rules.set(t.id,this)}updateRule(t){this.rule=t,this.style=function(t){const e=t.style;return`\n${e.hasOwnProperty("bold")?`font-weight: ${e.bold?"bold":"normal"}!important;`:""}\n${e.hasOwnProperty("italic")?`font-style: ${e.italic?"italic":"normal"}!important;`:""}\n${e.hasOwnProperty("underline")?`text-decoration: ${e.underline?"underline":"none"}!important;`:""}\n${e.hasOwnProperty("color")?`color: ${e.color}!important;`:""}\n${e.hasOwnProperty("background")?`background-color: ${e.background}!important;`:""}\n${e.hasOwnProperty("size")?`font-size: ${e.size}px!important;`:""}\n`.trim()}(t)}async mark(t){if(this.rule.disabled||T.IS_DISABLED)return;const e=t?new R(t):await P.markPromise,s=await P.executor.addWork((()=>new Promise((t=>{const s={...M,shadowDOM:T.ENABLE_SHADOW_DOM,element:this.elementName,exclude:this.exclude,acrossElements:!!this.rule.search.acrossElements,accuracy:this.rule.search.exactMatch?{value:"exactly",limiters:["!",":","@","\\","`",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/",";","<","=",">","?","[","]","^","_","{","|","}","~"]}:"partially",filter:t=>!(!T.ENABLE_CONTENTEDITABLE&&t.parentElement?.closest('[contenteditable="true"]')),done:e=>t(e||0),each:t=>{t.setAttribute("style",this.style),this.rule.note&&(t.title=this.rule.note)}};this.rule.search.regexp?e.markRegExp(new RegExp(this.rule.text,this.rule.search.caseSensitive?"":"i"),{...s}):e.mark(this.rule.text,{...s,separateWordSearch:this.rule.search.eachWord,diacritics:this.rule.search.diacritics,caseSensitive:this.rule.search.caseSensitive})}))));return this.matchesCount+=s,D(),s}static async multiMark(t){if(T.IS_DISABLED||0===t.length)return;const[e]=t,s=function(t,e){const s=new Map;if(!t)return s;for(let r=0;r<t.length;r++){const o=t[r],n=o[e];s.set(String(n),o)}return s}(t,"lowerText"),r=await P.markPromise,o=[],n=await P.executor.addWork((()=>new Promise((s=>{r.mark(t.map((t=>t.rule.text)).join(" "),{...M,element:e.elementName,exclude:["textarea"],done:t=>s(t||0),each:t=>o.push(t),separateWordSearch:!0,acrossElements:!!e.rule.search.acrossElements,diacritics:!1,caseSensitive:!1})}))));return o.forEach((t=>{const e=t.textContent.toLowerCase(),r=s.get(e);r&&(t.setAttribute("style",r.style),r.rule.note&&(t.title=r.rule.note))})),D(),n}async unmark(t){const e=t&&new R(t)||await P.markPromise;await P.executor.addWork((()=>new Promise((t=>e.unmark({done:()=>t(0),element:this.elementName}))))),t||(this.matchesCount=0)}async reMark(t){return await this.unmark(t),await this.mark(t)}async deleteSelf(){P._rules.delete(this.rule.id),await this.unmark()}static totalCount(){return v([...P._rules.values()].map((t=>t.matchesCount)))}static statistics(){return[...P._rules.values()].map((t=>`${t.rule.name||t.rule.text||""}:\t ${t.matchesCount}`)).join("\n")}static addEventHandler(t,e){switch(t){case"before":P.beforeHandlers.push(e);break;case"after":P.afterHandlers.push(e)}}static getElementsByRuleId(t){return document.getElementsByTagName(P.ELEMENT_PREFIX+t)}static async removeAll(){await Promise.all([...P._rules.values()].map((t=>t.unmark()))),P._rules.clear()}static async highlightRules(t){const e=t.map((t=>new P(t))).filter((t=>!t.rule.disabled));if(!T.PERF_GROUP_SIMILAR)return await Promise.all(e.map((t=>t.mark())));const{true:s,false:r}=function(t,e){const s=[],r=[];for(let o=0;o<t.length;o++){const n=t[o];(e(n,o)?s:r).push(n)}return{true:s,false:r}}(e,(t=>{const{diacritics:e,caseSensitive:s,regexp:r,eachWord:o}=t.rule.search;return e||s||r||o}));for(const t of s)await t.mark();const o=function(t,e){const s=new Array(Math.ceil(t.length/e)),r=Math.ceil(t.length/e);for(let o=0,n=0;o<r;++o,n+=e)s[o]=t.slice(n,n+e);return s}(r,500);for(const t of o)await P.multiMark(t)}}const $=new class{maxValue;options;i;constructor(t,e={}){this.maxValue=t,this.options=e,this.i=0,e.mutation&&self.setInterval((()=>this.i=Math.max(0,this.i+e.mutation.value)),e.mutation.interval)}get current(){return this.i}incrementOK(){return this.i=this.options.allowOverflow?this.i+1:Math.min(this.maxValue,this.i+1),this.i<this.maxValue}incrementErr(){return!this.incrementOK()}}(1e3,{mutation:{interval:(j=10,1e3*j),value:-10}});var j;const W=new MutationObserver((function(t,e){const s=new Set;for(let e=0;e<t.length;e++){const r=t[e];if("childList"===r.type){const t=r.addedNodes;for(let e=0;e<t.length;e++){const r=t[e];(r instanceof Text||r instanceof HTMLElement&&!r.nodeName.startsWith(P.ELEMENT_PREFIX))&&s.add(r)}}}Promise.resolve().then((()=>G(s,"mark")))})),F=new MutationObserver((function(t,e){const s=new Set;for(let e=0;e<t.length;e++){const r=t[e];if("characterData"===r.type){const t=r.target,e=t.parentElement;if(!V&&t instanceof Text&&t.textContent&&t.nextSibling?.nodeName.startsWith(P.ELEMENT_PREFIX))do{t.nextSibling?.remove()}while(t.nextSibling instanceof Text);!V&&e instanceof HTMLElement&&!e.nodeName.startsWith(P.ELEMENT_PREFIX)&&s.add(e)}}Promise.resolve().then((()=>G(s,"reMark")))}));let V=!1;P.addEventHandler("before",(()=>V=!0)),P.addEventHandler("after",(()=>V=!1));const H=m((async()=>{await I,W.observe(document.body,{subtree:!0,childList:!0}),F.observe(document.body,{subtree:!0,characterData:!0})}));function G(t,e){if(0===t.size)return;if($.incrementErr())return W.disconnect(),void F.disconnect();const s=Array.from(t).filter((t=>t instanceof HTMLElement));Array.from(P._rules.values()).map((t=>t[e](s)))}const J=new Promise((t=>document&&"complete"===document.readyState?t():window.addEventListener("load",(()=>t()))));new Promise((t=>window.addEventListener("load",t)));const[B,z]=h();Promise.resolve();new Map;const X=t=>Array.isArray(t)?t:[t];const U=new Set(["svg","path","circle","text"]);function q(t,e,s){const r=U.has(t)?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t);if(e){const t=n(e)?{textContent:e}:e;Object.entries(t).forEach((([e,s])=>{switch(e){case"text":case"textContent":r[e]=s;break;case"handlers":Object.assign(r,t.handlers);break;default:r.setAttribute(e,s)}}))}return s&&X(s).forEach((t=>{t&&r.appendChild(t)})),r}const K=t=>null===t.offsetParent;const Z=N(30,(function(){const t=window.innerHeight,e=document.scrollingElement.scrollHeight,s=document.scrollingElement.scrollTop,r=t/e,o=[...P._rules.values()].map((t=>{if(!t.hasSideList)return;const e=Array.from(P.getElementsByRuleId(t.ruleId)).map((t=>{const{top:e,width:o,height:n}=t.getBoundingClientRect();if(0===o||0===n)return;return{top:(s+e+n/2)*r,element:t}})).filter(i);return 0!==e.length?{color:t.ruleStyle.background||t.ruleStyle.color||T.DEFAULT_BACKGROUND_COLOR,matches:e}:void 0})).filter(i);if(0===o.length)Y.remove();else{const t=o.flatMap((({color:t,matches:e})=>e.map((({top:e,element:s})=>({top:e,element:s,color:t}))))),e=t.map((({top:t,color:e})=>q("div",{class:"item",style:`top: ${Math.round(t)}px; background-color: ${e}`})));Q.replaceChildren(),Q.appendChild(function(t){const e=document.createDocumentFragment();for(let s=0;s<t.length;s++)e.appendChild(t[s]);return e}([q("div",{class:"wrapper",handlers:{onclick:e=>function(t,e){const s=t.y,r=function(t,e,s){if(e[Symbol.iterator]().next().done)return;let r,o=Infinity;for(let n of e){const e=Math.abs(t-s(n));e<o&&(o=e,r=n)}return r}(s,e,(t=>t.top));K(r.element)&&Z();r.element.scrollIntoView({inline:"center",block:"center",behavior:"smooth"})}(e,t)}},e),q("style",{textContent:tt()})])),document.body.appendChild(Y)}}),{maximumDelay:50}),Y=document.createElement(`${P.ELEMENT_PREFIX}-matches-list`),Q=Y.attachShadow({mode:"closed"});S.addOnChangeListener((()=>Y.setAttribute("style",function(t="",{important:e=!0,allToInitial:s=!0}={}){if(!s&&!e)return t;const r=t.split(";").filter((t=>t.trim())),o=s?["all: initial","z-index: 2147483647","font-family: Verdana, system-ui, sans-serif, Helvetica","font-size: 12px",...r]:r;return(e?o.map((t=>`${t}!important;`)):o).join("")}(`\ndisplay: block;\nwidth: ${T.LIST_WIDTH}px;\nheight: 100%;\nposition: fixed;\n${"left"===T.LIST_POSITION?"left: 0;":"right: 0;"}\ntop: 0;\n`))),{dummyInitValue:A}),P.addEventHandler("after",Z);const tt=()=>`\n.wrapper {\n  width: 100%;\n  height: 100%;\n  cursor: pointer;\n  position: relative;\n}\n.item {\n  height: ${T.LIST_ITEM_HEIGHT}px;\n  width: 100%;\n  position: absolute;\n}\n`;if(!e())throw"Forbidden to be self-injected";browser.runtime.onMessage.addListener((t=>{switch(t.type){case"ping":return Promise.resolve(!0);case"rules":return async function(t){await A,await J,await l(100),await P.removeAll(),await H(),await P.highlightRules(t)}(t.rules).then((()=>u({type:"rules_loaded"})));case"get_active_rules":return Promise.resolve([...P._rules.keys()])}})),browser.storage.onChanged.addListener(function({areaName:t,filter:e,callback:s}){return(r,o)=>{if(t&&t!==o)return;const n=function(t,{filter:e}={}){return Object.fromEntries(Object.entries(t).filter((([t,s])=>!e||e(t,s))).map((([t,e])=>[t,e?.newValue])))}(r,{filter:e});s(n)}}({filter:(t,e)=>P._rules.has(_(t)),callback:async t=>{await Promise.all(Object.entries(t).map((([t,e])=>async function(t,e){const s=P._rules.get(t)||e&&new P(e)||o("rule not found!");e?(s.updateRule(e),await s.reMark()):await s.deleteSelf()}(_(t),e))))}})),S.addOnChangeListener((({newValue:t,oldValue:e})=>{"IS_DISABLED"in(t||{})&&async function(){for(const t of P._rules.values())await t.reMark()}()})),r()})();