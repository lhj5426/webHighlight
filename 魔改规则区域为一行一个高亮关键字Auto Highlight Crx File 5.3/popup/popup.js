(()=>{"use strict";const e=self.location.pathname===`/${browser.runtime.getManifest().background?.page}`||"/background.loader.js"===self.location.pathname||!1;const t=()=>"chrome-extension:"!==self.location.protocol;!function(e){const t=new URL(e);t.origin,t.pathname,t.search}("https://chrome.google.com/webstore/detail/auto-highlight/ndndibnggapaodjdfoeehgmmpppedgfb/");const o="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,s=e=>o&&!browser?.runtime?e:browser.runtime.getURL(e);let n=!1;const i=Promise.resolve(!1);let a=!1;i.then((e=>a=!1));async function r(){const[e]=await browser.tabs.query(n?{active:!0}:{active:!0,lastFocusedWindow:!0});return e}const c=()=>browser.tabs.getCurrent().then((e=>e?.id?browser.tabs.remove(e.id):void 0));let l=!1;const h=(async()=>await i&&await async function(){return 0}()>=79)().then((e=>l=e));async function d(){await i&&!await h&&await c(),window.close()}const u=(...e)=>{},g=e=>{throw Error(e)},m=e=>"string"==typeof e,p=e=>"number"==typeof e,w=e=>(e=>!isNaN(e-parseFloat(e)))(e),y=e=>"function"==typeof e?e():e,f=()=>Date.now(),b=e=>new Promise((t=>setTimeout(t,e))),_=()=>{const e=[];return e.splice(0,0,new Promise(((t,o)=>{e.push(t,o)}))),e};function v(e,t){try{return e()}catch(e){return t?.(e)}}class k{maxConcurrentJobs;options;_work;_runningJobs;_lastRunDoneTime;constructor(e=1,t={}){this.maxConcurrentJobs=e,this.options=t,this._work=this.options.initialWork||[],this._runningJobs=new Set,this._lastRunDoneTime=0}hasFreeSlot(){return this._runningJobs.size<y(this.maxConcurrentJobs)}getRunningJobsCount(){return this._runningJobs.size}getPendingJobsCount(){return this._work.length}async addWork(e,t){return new Promise(((o,s)=>{const n={info:t,fn:()=>{const i=e();i.finally((async()=>{this._runningJobs.delete(n),this.options.afterEach&&await this.options.afterEach(t),i.then(o,s).finally((()=>{Promise.resolve().then((()=>this.startWork())),this._lastRunDoneTime=Date.now()}))}))}};this._work.push(n),this.startWork()}))}async startWork(){if(this.options.minDelayAfterRun&&this._work.length>0){const e=Date.now()-this._lastRunDoneTime;e<this.options.minDelayAfterRun&&await b(this.options.minDelayAfterRun-e)}for(;this._work.length>0&&this._runningJobs.size<y(this.maxConcurrentJobs)&&(0===this._runningJobs.size||!this.options.canRunWithOthers||this.options.canRunWithOthers(this._work[0].info,[...this._runningJobs].map((e=>e.info))));){const e=this._work.shift();this._runningJobs.add(e),this.options.beforeEach&&await this.options.beforeEach(e.info),e.fn()}}}const{port1:x,port2:E}=new MessageChannel;const A=()=>new Promise((e=>{E.onmessage=()=>e(),x.postMessage(0)}));var P,S;(e=>{e.sync="sync",e.local="local",e.session="session"})(P||(P={})),(e=>{e.loading="loading",e.complete="complete"})(S||(S={}));class T{key;options;_listeners;_listenForChangesFn;storageArea;constructor(e,t={storageArea:"local"}){this.key=e,this.options=t,this._listeners=Array(),this._listenForChangesFn=function(e){let t,o=!1;return(...s)=>o?t:(o=!0,t=e(...s))}((()=>{P[this.storageArea]&&browser.storage[this.storageArea].onChanged.addListener((e=>{e[this.key]&&this._listeners.forEach((t=>t(e[this.key])))}))})),this.storageArea=t.storageArea}async addOnChangeListener(e,{dummyInitValue:t}={}){if(this._listeners.push(e),this._listenForChangesFn(),t){const o=(e=>e instanceof Promise)(t)?await t:t;e({newValue:o,oldValue:o})}}}class I extends T{key;getDefaultValue;options;_updateExecutor;_setExecutor;get legacyStore(){return"localStorage"===this.storageArea?self.localStorage:self.sessionStorage}constructor(e,t,o={storageArea:"local"}){super(e,o),this.key=e,this.getDefaultValue=t,this.options=o,this._updateExecutor=new k,this._setExecutor=new k}async reset(){return this.set(await this.getDefaultValue())}async orDefault(e){return e.hasOwnProperty(this.key)?e[this.key]:await this.getDefaultValue()}async get(){const e="custom"===this.storageArea?await this.options.customDataSource.get()||await this.getDefaultValue():"remote"===this.storageArea?await(await fetch(this.options.remoteApi.url,await this.getRequestInit())).json()||await this.getDefaultValue():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?this.options.localStorageTextOnly?v((()=>this.legacyStore.getItem(this.key)),(()=>""))||await this.getDefaultValue():await v((()=>JSON.parse(this.legacyStore.getItem(this.key)||"")),(()=>this.getDefaultValue())):await browser.storage[this.storageArea].get(this.key).then((e=>this.orDefault(e)));return this.options.onBeforeLoad?await this.options.onBeforeLoad(e):e}async remove(){return"custom"===this.storageArea?await this.options.customDataSource.remove():"remote"===this.storageArea?(await fetch(this.options.remoteApi.url,await this.getRequestInit("DELETE"))).json():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?v((()=>this.legacyStore.removeItem(this.key))):browser.storage[this.storageArea].remove(this.key)}async update(e){return this._updateExecutor.addWork((()=>this.get().then(e).then((e=>this.set(e)))))}async set(e){return this._setExecutor.addWork((async()=>{e=this.options.onBeforeSave?await this.options.onBeforeSave(e):e;const t=await("custom"===this.storageArea?await this.options.customDataSource.set(e):"remote"===this.storageArea?void await fetch(this.options.remoteApi.url,await this.getRequestInit("POST",JSON.stringify(e))):"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?v((()=>this.legacyStore.setItem(this.key,this.options.localStorageTextOnly?String(e):JSON.stringify(e)))):browser.storage[this.storageArea].set({[this.key]:e}));return"session"===this.storageArea&&(await A(),await A(),await A()),t}))}async setWith(e,t){return"remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?g("missing"):browser.storage[this.storageArea].set(Object.assign({[this.key]:e},t))}async getWith(...e){const t=e.map((e=>m(e)?e:e.key)),o="remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?g("missing"):await browser.storage[this.storageArea].get([this.key,...t]),s=await this.orDefault(o),n=e.map((async e=>m(e)?o[e]:await e.orDefault(o)));return[s,...await Promise.all(n)]}async getRequestInit(e="GET",t){const o=await y(this.options.remoteApi.GET_Headers),s=await(this.options.remoteApi.authToken?.());return{method:e,body:t,...o,...s?{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json",...o?.headers}}:{}}}}function C(e,t){return function(e){const t=Object.getOwnPropertyNames(e);for(let o=0;o<t.length;o++)delete e[t[o]]}(e),Object.assign(e,t)}t()?browser.storage.session={get:e=>browser.runtime.sendMessage({type:"_session_store_get",key:e}),set:e=>browser.runtime.sendMessage({type:"_session_store_set",items:e}),remove:e=>browser.runtime.sendMessage({type:"_session_store_remove",key:e}),clear:()=>Promise.resolve(),onChanged:{addListener:()=>({removeListener:()=>{}}),removeListener:()=>({removeListener:()=>{}}),hasListener:()=>!1}}:e&&browser.runtime.onMessage.addListener((e=>{switch(e.type){case"_session_store_get":return browser.storage.session.get(e.key);case"_session_store_set":return browser.storage.session.set(e.items);case"_session_store_remove":return browser.storage.session.remove(e.key)}}));const L=async function(e,t){const o=e.storageArea;P[o]&&browser.storage[o].onChanged.addListener((o=>{o[e.key]&&C(t,o[e.key].newValue||{})}));const s=await e.get();return s?(Object.entries(t).filter((([e])=>!s.hasOwnProperty(e))).map((([e,t])=>s[e]=t)).length>0&&await e.set(s),C(t,s||{})):(await e.set(t),t)}(new I("options",(()=>{})),{FONT_SIZE:18,SIDE_BAR_SIZE:256,DEFAULT_BACKGROUND_COLOR:"#FFFF00FF",DEFAULT_TEXT_COLOR:"#7c0000",DEFAULT_LIST_ON:!0,EXCLUDED_DOMAINS:[],LIST_POSITION:"right",LIST_WIDTH:20,LIST_ITEM_HEIGHT:2,STORAGE_AREA:P.sync}),R=(new I("last_rule_id",(()=>0)),new I("last_selection",(()=>({selection:"",isTemp:!1,allPages:!1,tabId:0})),{storageArea:"session"})),O=o?Promise.resolve():new Promise((e=>"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",(()=>e())))),[M,D]=_(),F=(Promise.resolve(),(e,t)=>e?browser.i18n.getMessage(e,t):"");new Map;const N=2147483647;const W=e=>Array.isArray(e)?e:[e];const z=new Set(["svg","path","circle","text"]);function U(e,t,o){const s=z.has(e)?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);if(t){const e=m(t)?{textContent:t}:t;Object.entries(e).forEach((([t,o])=>{switch(t){case"text":case"textContent":s[t]=o;break;case"handlers":Object.assign(s,e.handlers);break;default:s.setAttribute(t,o)}}))}return o&&W(o).forEach((e=>{e&&s.appendChild(e)})),s}const J=(e,t,o)=>e.style.setProperty(t,o,"important");function j(e="",{important:t=!0,allToInitial:o=!0}={}){if(!o&&!t)return e;const s=e.split(";").filter((e=>e.trim())),n=o?["all: initial",`z-index: ${N}`,"font-family: Verdana, system-ui, sans-serif, Helvetica","font-size: 12px",...s]:s;return(t?n.map((e=>`${e}!important;`)):n).join("")}const B=(e,{rootNode:t=e,USE_PERCENT:o=!1,PERCENT_RATIO:s=100,elementWidth:n,dontMovePredicate:i=u,onMoveStart:a=u,onMoveEnd:r=u,autoLockFrames:c=!1,autoLockFramesContainer:l,keepInWindow:h}={})=>{let d=0,g=0,m=0,w=0,y=!1,f=u;const b=e=>Math.round(e*n/s),_=e=>Math.round(e*s/n),v=(e,t,s)=>o?f(_(e),_(t),s):f(e,t,s);return t.addEventListener("mousedown",(function(e){if(0!==e.button||i(e))return;a(e),y=!0,e.preventDefault(),c&&(o=l||t,o.querySelectorAll("iframe").forEach((e=>J(e,"pointer-events","none"))));var o;d=e.pageX-m,g=e.pageY-w;const s=e=>{w=e.pageY-g,m=e.pageX-d,v(m,w,e)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",(e=>{document.removeEventListener("mousemove",s),y=!1,c&&function(e){e.querySelectorAll("iframe").forEach((e=>e.style.removeProperty("pointer-events")))}(l||t),h&&A(),r(e)}),{once:!0})})),h&&window.addEventListener("resize",(()=>A())),{node:e,getX:x,getY:k,shift:(e,t)=>{m+=e,w+=t,f(m,w)},setCallback:e=>f=e,isMoving:()=>y,setPosition:E,moveToViewport:A};function k(){return o?_(w):w}function x(){return o?_(m):m}function E(e=x(),t=k(),s=!1){o&&(e=b(e),t=b(t));const n=m!==e||w!==t;m=e,w=t,(n||s)&&v(m,w)}function A({pixelsToKeep:t}={}){const{top:o,left:s,bottom:n,right:i,height:a,width:r}=e.getBoundingClientRect();o<0&&E(void 0,0);const c=p(t)?t:p(h)?h:0,l=Math.max(0,r-c),d=Math.max(0,a-c);s<0-l&&E(0-l,void 0),n>window.innerHeight+d&&E(void 0,Math.max(0,window.innerHeight-a+d)),i>window.innerWidth+l&&E(Math.max(0,window.innerWidth-r+l),void 0)}},H=e=>`${e}px`;function V(e,t,{maximumDelay:o=0}={}){let s=-1,n=-1,i=u;function a(){s>0&&self.clearTimeout(s),o&&n>0&&self.clearTimeout(n),s=n=-1,i=u}return r.flush=()=>i(),r.cancel=()=>(-1!==s||-1!==n)&&(a(),!0),r;function r(r=t,c=e){if(self.clearTimeout(s),s=-1,!1===c)return;const l=i=()=>{a(),r()};s=self.setTimeout(l,c),o&&n<0&&(n=self.setTimeout(l,o))}}const $="__modal_window_custom_event";const X=(e,t,o)=>Math.max(e,Math.min(t,o||0));function q(e,{width:t=800,height:o=600,draggableStyle:n="",onClose:i=u,appendToBody:a=!0,rememberPositionKey:r="",closableOverlay:c=!0,overlayBackground:h="rgba(0, 0, 0, 0.3)",closeOnOverlayClick:d=!0,closeOnESC:g=!0}){const m={get node(){return e},get overlayNode(){return S},minimize:async function(e){z("0"),E.style.transition="top 550ms",E.classList.add("pointer_all"),E.title=F("label_restore");const t=R.getY();R.setPosition(void 0,window.innerHeight-64),E.addEventListener("mousedown",(o=C=()=>{z("100%"),E.classList.remove("pointer_all"),E.title="",b(250).then((()=>E.style.removeProperty("transition"))),R.setPosition(void 0,t),e?.()},e=>{(e=>{e.preventDefault(),e.stopImmediatePropagation()})(e),o(e)}),{capture:!0,once:!0});var o},maximize:async function(){E.style.transition="top 250ms, left 250ms, width 250ms, height 250ms";R.setPosition(40,40),W.setPosition(window.innerWidth-80,window.innerHeight-80),await b(250),E.style.removeProperty("transition")},closeModal:()=>{S.isConnected&&(S.remove(),i(),((e,t=[])=>{let o;for(;o=e.pop();)o.apply(null,t)})(T),window.removeEventListener("keydown",p))}},p=(y=m.closeModal,e=>{"Escape"===e.key&&y?y(e):"Enter"===e.key&&f?f(e):_&&_(e)});var y,f,_;g&&window.addEventListener("keydown",p);const v=`\nz-index: 20;\nwidth: ${c?"100%":"0"};\nheight: 100%;\nbackground: ${h};\nposition: fixed;\ntop: 0;\nleft: 0;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\n`,k=`\ndisplay: flex;\nflex-direction: column;\nopacity: 0;\ntop: 0;\nleft: 0;\nposition: fixed;\nbackground: transparent;\nbox-shadow: rgba(0, 0, 0, 0.5) 0px 0px 5px;\nwidth: ${t}px;\nheight: ${o}px;\nmin-width: 320px;\nmin-height: 170px;\nmax-width: 100%;\nmax-height: ${l?"calc(100% - 44px)":"100%"};\n/*border: 1px solid rgb(65, 65, 65);*/\n`,x=`\nz-index: 10;\ncursor: move;\nposition: absolute;\nwidth: 100%;\ntop: 0;\nleft: 0;\nheight: 15px;\n${n}\n`;let E;const A=new I(r,(()=>({}))),P=V(500),S=U("div",{"data-modal-overlay":1,style:v,handlers:{onmousedown:e=>{e.target===S&&(S.onclick=e=>{e.target===S&&d&&m.closeModal()})}}},E=U("div",{style:k},[U("div",{style:"\ndisplay: flex;\noverflow: auto;\nwidth: 100%;\nheight: 100%;\n"},e),U("draggable-top",{style:x,"data-draggable-top":0,handlers:{ondblclick:()=>{m.maximize()}}}),U("img",{style:"\nz-index: 10;\ncursor: nw-resize;\nwidth: 10px;\nopacity: 0.2;\npadding: 2px;\nposition: absolute;\nright: 0;\nbottom: 0;\n-moz-user-select: none;\nuser-select: none;\n",src:s("utils/svg/resize-corner.svg"),"data-resize-corner":0})])),T=Array();let C=u;var L;L=e=>{switch(e.type){case"changeOpacity":S.style.opacity=e.opacity;break;case"changeTransparency":S.style.backgroundColor=e.isTransparent?"transparent":h;break;case"changeOverlayCloseOnClick":d=e.value;break;case"maximize":m.maximize();break;case"addOnCloseHandler":T.push(e.callback);break;case"removeOnCloseHandler":((e,t)=>{for(let o=e.length-1;o>=0;o--)e[o]===t&&e.splice(o,1)})(T,e.callback);break;case"close":m.closeModal();break;case"minimize":m.minimize(e.restoreCallback);break;case"restore":C()}},S.addEventListener($,(e=>L(e.detail))),a&&document.body.appendChild(S);const R=B(E,{autoLockFrames:!0,keepInWindow:250,dontMovePredicate:e=>e.target!==E&&!e.target.hasAttribute("data-draggable-top")});R.setCallback(((e,t,o)=>{J(E,"top",H(t)),J(E,"left",H(e)),r&&P((()=>A.update((({w:o,h:s})=>({x:e,y:t,w:o,h:s})))))}));const O=document.documentElement.clientWidth,M=document.documentElement.clientHeight,[D,N]=[O/2-t/2,M/2-o/2];R.setPosition(X(0,O-t-10,D),X(0,M-o-10,N)),J(E,"opacity","1");const W=function(e,{cornerNode:t=e.querySelector("[data-resize-corner]"),originalWidth:o,originalHeight:s,callback:n=u,autoLockFrames:i=!1}){let a=o,r=s;const c=B(t,i?{autoLockFrames:!0,autoLockFramesContainer:e}:{});return c.setCallback(((t,i,c)=>{a=o+t,r=s+i,J(e,"width",H(a)),J(e,"height",H(r)),n(a,r,c)})),{setPosition:(e,t,n)=>c.setPosition(e-o,t-s,n),getWidth:()=>a,getHeight:()=>r}}(E,{autoLockFrames:!0,originalWidth:t,originalHeight:o,callback:(e,t,o)=>{r&&A.update((({x:o,y:s})=>({w:e,h:t,x:o,y:s})))}});return r&&A.get().then((({x:e,y:t,w:o,h:s})=>{[e,t].every(w)&&R.setPosition(e,t,!0),[o,s].every(w)&&W.setPosition(o,s,!0),R.moveToViewport()})),m;function z(e){["width","height"].forEach((t=>S.style.setProperty(t,e)))}}function G(e){return s(`/editor/editor.html#${t=e,encodeURIComponent(JSON.stringify(t))}`);var t}async function Y(t,o={}){const s=W(t);const{cookieStoreId:i,inNewTab:a=!1,nextToCurrent:c=!1,active:l=!1,inNewWindow:h=!1,windowId:d,windowOptions:u={},forceIncognitoWindow:g=!1,stopOpenerTabId:m,_directCall:p}=o,w=h||g;if(!e&&!p)return function(e,t){if(t._directCall)throw Error("infinite loop???");return t._directCall=!0,browser.runtime.sendMessage(new K(e,t))}(s,o);const y={},[f,...b]=s,_=await v(f,0,d);return b.forEach(((e,t)=>v(e,t+1,_.windowId))),_;async function v(e,t,o){if(w)return browser.windows.create({url:e,...u,...y,...g?{incognito:!0}:{}}).then((e=>e?.tabs[0]));if(a||t>0){const i=l&&0===t,a=await r()||{id:void 0,index:void 0},h=(s=a.index,Number.isFinite(s)?a.index+1:void 0),d=!(!n&&!m),u=t=>browser.tabs.create({url:e,...y,windowId:o,active:i,...c?{index:h}:{},...t?{}:{openerTabId:a.id}});return d?await u(d):await u(d).catch((()=>u(!0)))}return await browser.tabs.update({url:e});var s}}class K{links;options;type;constructor(e,t){this.links=e,this.options=t,this.type="openURL"}}function Z(e,t){if(null!=e)return t(e)}e&&browser.runtime.onMessage.addListener((e=>{if("openURL"===e.type)return Y(e.links,e.options)}));class Q{selection;url;allPages;isTemp;tabId;editorURL;constructor(e,t,o,s,n){this.selection=e,this.url=t,this.allPages=o,this.isTemp=s,this.tabId=n,this.editorURL=G({selection:e,url:t,allPages:o,isTemp:s,tabId:n})}async openInNewTab(){return Y(this.editorURL,{active:!0,inNewTab:!0,nextToCurrent:!0})}async openInNewWindow(){await browser.windows.create({url:this.editorURL,type:"popup",state:"normal",width:900,height:600})}async injectToTab(e,t){await browser.scripting.executeScript({target:{tabId:e,frameIds:Z(t,(e=>[e]))},files:["/browser-polyfill.min.js","/content_scripts/build_highlighter.js"]})}}class ee extends Q{isPopUp;static CS_IFRAME_PREFIX="_cs_auto_highlight_iframe_";static POPUP_IFRAME_PREFIX="_popup_auto_highlight_iframe_";container;iframeNode;iframeName;constructor(e,o,s,n,i,a){super(o,s,n,i,a),this.isPopUp=e,this.iframeName=(this.isPopUp?ee.POPUP_IFRAME_PREFIX:t()?ee.CS_IFRAME_PREFIX:"_web_auto_highlight_iframe_")+f(),this.iframeNode=U("iframe",{src:this.editorURL,style:"width: 100%; height: 100%;",name:this.iframeName,frameborder:0,handlers:{onload:()=>this.iframeNode.focus()}}),browser.runtime.onMessage.addListener((e=>{"closeIframe"===e.type&&e.iframeName===this.iframeName&&r.closeModal()}));const r=q(this.iframeNode,{rememberPositionKey:"_main_modal",appendToBody:!1,closableOverlay:!1,draggableStyle:"\nwidth: calc(100% - 244px);\nleft: 64px;\nheight: 56px;"});this.container=U("auto-highlight-modal-jm",{style:j(te)});this.container.attachShadow({mode:"closed"}).appendChild(r.overlayNode)}async appendToBody(){await O,document.body.appendChild(this.container)}async appendIframeToBody(){await O,document.body.appendChild(this.iframeNode)}static isRunningInContentScript(){return window.name.startsWith(this.CS_IFRAME_PREFIX)}static isRunningInPopUp(){return window.name.startsWith(this.POPUP_IFRAME_PREFIX)}}const te=`\nposition: fixed;\ndisplay: block;\nz-index: ${N} !important;\n`,oe=(()=>{let e=0;return()=>++e})();browser.runtime.onMessage.addListener((e=>{if("poison_pill_popup"===e.type)d()})),async function(){const[e,{url:t,id:o},{selection:s,isTemp:n,allPages:a}]=await Promise.all([L,r(),R.get()]);R.reset();const c=new ee(!0,s,t,a,n,o);e.ALWAYS_NEW_TAB?(document.body?.remove(),c.openInNewTab(),d()):(await O,c.appendIframeToBody(),await i&&async function(e,t){const o=`id_file_${t?oe():e}`;if(document.getElementById(o))return;const s=document.createElement("link");s.href=t?`data:text/css;base64,${btoa(e)}`:e,s.id=o,s.type="text/css",s.rel="stylesheet",new Promise(((e,t)=>{s.onload=e,s.onerror=t,document.head.appendChild(s)}))}("html, body {height: 100%}",!0))}()})();