(()=>{var e={555:(e,t,s)=>{var a=s(178),r={whitespace:/\s+/g,urlHexPairs:/%[\dA-F]{2}/g,quotes:/"/g};function i(e){switch(e){case"%20":return" ";case"%3D":return"=";case"%3A":return":";case"%2F":return"/";default:return e.toLowerCase()}}function n(e){if("string"!=typeof e)throw new TypeError("Expected a string, but received "+typeof e);var t,s;return 65279===e.charCodeAt(0)&&(e=e.slice(1)),"data:image/svg+xml,"+function(e){return encodeURIComponent(e).replace(r.urlHexPairs,i)}((s=e,t=s.trim().replace(r.whitespace," "),Object.keys(a).forEach((e=>{a[e].test(t)&&(t=t.replace(a[e],e))})),t).replace(r.quotes,"'"))}n.toSrcset=function(e){return n(e).replace(/ /g,"%20")},e.exports=n},178:e=>{e.exports={aqua:/#00ffff(ff)?(?!\w)|#0ff(f)?(?!\w)/gi,azure:/#f0ffff(ff)?(?!\w)/gi,beige:/#f5f5dc(ff)?(?!\w)/gi,bisque:/#ffe4c4(ff)?(?!\w)/gi,black:/#000000(ff)?(?!\w)|#000(f)?(?!\w)/gi,blue:/#0000ff(ff)?(?!\w)|#00f(f)?(?!\w)/gi,brown:/#a52a2a(ff)?(?!\w)/gi,coral:/#ff7f50(ff)?(?!\w)/gi,cornsilk:/#fff8dc(ff)?(?!\w)/gi,crimson:/#dc143c(ff)?(?!\w)/gi,cyan:/#00ffff(ff)?(?!\w)|#0ff(f)?(?!\w)/gi,darkblue:/#00008b(ff)?(?!\w)/gi,darkcyan:/#008b8b(ff)?(?!\w)/gi,darkgrey:/#a9a9a9(ff)?(?!\w)/gi,darkred:/#8b0000(ff)?(?!\w)/gi,deeppink:/#ff1493(ff)?(?!\w)/gi,dimgrey:/#696969(ff)?(?!\w)/gi,gold:/#ffd700(ff)?(?!\w)/gi,green:/#008000(ff)?(?!\w)/gi,grey:/#808080(ff)?(?!\w)/gi,honeydew:/#f0fff0(ff)?(?!\w)/gi,hotpink:/#ff69b4(ff)?(?!\w)/gi,indigo:/#4b0082(ff)?(?!\w)/gi,ivory:/#fffff0(ff)?(?!\w)/gi,khaki:/#f0e68c(ff)?(?!\w)/gi,lavender:/#e6e6fa(ff)?(?!\w)/gi,lime:/#00ff00(ff)?(?!\w)|#0f0(f)?(?!\w)/gi,linen:/#faf0e6(ff)?(?!\w)/gi,maroon:/#800000(ff)?(?!\w)/gi,moccasin:/#ffe4b5(ff)?(?!\w)/gi,navy:/#000080(ff)?(?!\w)/gi,oldlace:/#fdf5e6(ff)?(?!\w)/gi,olive:/#808000(ff)?(?!\w)/gi,orange:/#ffa500(ff)?(?!\w)/gi,orchid:/#da70d6(ff)?(?!\w)/gi,peru:/#cd853f(ff)?(?!\w)/gi,pink:/#ffc0cb(ff)?(?!\w)/gi,plum:/#dda0dd(ff)?(?!\w)/gi,purple:/#800080(ff)?(?!\w)/gi,red:/#ff0000(ff)?(?!\w)|#f00(f)?(?!\w)/gi,salmon:/#fa8072(ff)?(?!\w)/gi,seagreen:/#2e8b57(ff)?(?!\w)/gi,seashell:/#fff5ee(ff)?(?!\w)/gi,sienna:/#a0522d(ff)?(?!\w)/gi,silver:/#c0c0c0(ff)?(?!\w)/gi,skyblue:/#87ceeb(ff)?(?!\w)/gi,snow:/#fffafa(ff)?(?!\w)/gi,tan:/#d2b48c(ff)?(?!\w)/gi,teal:/#008080(ff)?(?!\w)/gi,thistle:/#d8bfd8(ff)?(?!\w)/gi,tomato:/#ff6347(ff)?(?!\w)/gi,violet:/#ee82ee(ff)?(?!\w)/gi,wheat:/#f5deb3(ff)?(?!\w)/gi,white:/#ffffff(ff)?(?!\w)|#fff(f)?(?!\w)/gi}},24:(e,t,s)=>{"use strict";const a=self.location.pathname===`/${browser.runtime.getManifest().background?.page}`||"/background.loader.js"===self.location.pathname||!1;!function(e){const t=new URL(e);t.origin,t.pathname,t.search}("https://chrome.google.com/webstore/detail/auto-highlight/ndndibnggapaodjdfoeehgmmpppedgfb/");const r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;const i=()=>Math.floor(Date.now()/864e5);const n=(...e)=>{},o=e=>{throw Error(e)},c=e=>"string"==typeof e,l=e=>(e=>!isNaN(e-parseFloat(e)))(e),h=e=>"function"==typeof e?e():e,u=()=>Date.now(),f=e=>!!e,g=()=>{const e=[];return e.splice(0,0,new Promise(((t,s)=>{e.push(t,s)}))),e};function d(e,t){try{return e()}catch(e){return t?.(e)}}class w{maxConcurrentJobs;options;_work;_runningJobs;_lastRunDoneTime;constructor(e=1,t={}){this.maxConcurrentJobs=e,this.options=t,this._work=this.options.initialWork||[],this._runningJobs=new Set,this._lastRunDoneTime=0}hasFreeSlot(){return this._runningJobs.size<h(this.maxConcurrentJobs)}getRunningJobsCount(){return this._runningJobs.size}getPendingJobsCount(){return this._work.length}async addWork(e,t){return new Promise(((s,a)=>{const r={info:t,fn:()=>{const i=e();i.finally((async()=>{this._runningJobs.delete(r),this.options.afterEach&&await this.options.afterEach(t),i.then(s,a).finally((()=>{Promise.resolve().then((()=>this.startWork())),this._lastRunDoneTime=Date.now()}))}))}};this._work.push(r),this.startWork()}))}async startWork(){if(this.options.minDelayAfterRun&&this._work.length>0){const t=Date.now()-this._lastRunDoneTime;t<this.options.minDelayAfterRun&&await(e=this.options.minDelayAfterRun-t,new Promise((t=>setTimeout(t,e))))}for(var e;this._work.length>0&&this._runningJobs.size<h(this.maxConcurrentJobs)&&(0===this._runningJobs.size||!this.options.canRunWithOthers||this.options.canRunWithOthers(this._work[0].info,[...this._runningJobs].map((e=>e.info))));){const e=this._work.shift();this._runningJobs.add(e),this.options.beforeEach&&await this.options.beforeEach(e.info),e.fn()}}}function m(){0}const{port1:p,port2:b}=new MessageChannel;const y=()=>new Promise((e=>{b.onmessage=()=>e(),p.postMessage(0)}));var _,A;(e=>{e.sync="sync",e.local="local",e.session="session"})(_||(_={})),(e=>{e.loading="loading",e.complete="complete"})(A||(A={}));class R{key;options;_listeners;_listenForChangesFn;storageArea;constructor(e,t={storageArea:"local"}){this.key=e,this.options=t,this._listeners=Array(),this._listenForChangesFn=function(e){let t,s=!1;return(...a)=>s?t:(s=!0,t=e(...a))}((()=>{_[this.storageArea]&&browser.storage[this.storageArea].onChanged.addListener((e=>{e[this.key]&&this._listeners.forEach((t=>t(e[this.key])))}))})),this.storageArea=t.storageArea}async addOnChangeListener(e,{dummyInitValue:t}={}){if(this._listeners.push(e),m(),this._listenForChangesFn(),t){const s=(e=>e instanceof Promise)(t)?await t:t;e({newValue:s,oldValue:s})}}}class k extends R{key;getDefaultValue;options;_updateExecutor;_setExecutor;get legacyStore(){return"localStorage"===this.storageArea?self.localStorage:self.sessionStorage}constructor(e,t,s={storageArea:"local"}){super(e,s),this.key=e,this.getDefaultValue=t,this.options=s,this._updateExecutor=new w,this._setExecutor=new w}async reset(){return this.set(await this.getDefaultValue())}async orDefault(e){return e.hasOwnProperty(this.key)?e[this.key]:await this.getDefaultValue()}async get(){const e="custom"===this.storageArea?await this.options.customDataSource.get()||await this.getDefaultValue():"remote"===this.storageArea?await(await fetch(this.options.remoteApi.url,await this.getRequestInit())).json()||await this.getDefaultValue():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?this.options.localStorageTextOnly?d((()=>this.legacyStore.getItem(this.key)),(()=>""))||await this.getDefaultValue():await d((()=>JSON.parse(this.legacyStore.getItem(this.key)||"")),(()=>this.getDefaultValue())):await browser.storage[this.storageArea].get(this.key).then((e=>this.orDefault(e)));return this.options.onBeforeLoad?await this.options.onBeforeLoad(e):e}async remove(){return"custom"===this.storageArea?await this.options.customDataSource.remove():"remote"===this.storageArea?(await fetch(this.options.remoteApi.url,await this.getRequestInit("DELETE"))).json():"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?d((()=>this.legacyStore.removeItem(this.key))):browser.storage[this.storageArea].remove(this.key)}async update(e){return this._updateExecutor.addWork((()=>this.get().then(e).then((e=>this.set(e)))))}async set(e){return this._setExecutor.addWork((async()=>{e=this.options.onBeforeSave?await this.options.onBeforeSave(e):e;const t=await("custom"===this.storageArea?await this.options.customDataSource.set(e):"remote"===this.storageArea?void await fetch(this.options.remoteApi.url,await this.getRequestInit("POST",JSON.stringify(e))):"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?d((()=>this.legacyStore.setItem(this.key,this.options.localStorageTextOnly?String(e):JSON.stringify(e)))):browser.storage[this.storageArea].set({[this.key]:e}));return"session"===this.storageArea&&(await y(),await y(),await y()),t}))}async setWith(e,t){return"remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?o("missing"):browser.storage[this.storageArea].set(Object.assign({[this.key]:e},t))}async getWith(...e){const t=e.map((e=>c(e)?e:e.key)),s="remote"===this.storageArea||"custom"===this.storageArea||"localStorage"===this.storageArea||"sessionStorage"===this.storageArea?o("missing"):await browser.storage[this.storageArea].get([this.key,...t]),a=await this.orDefault(s),r=e.map((async e=>c(e)?s[e]:await e.orDefault(s)));return[a,...await Promise.all(r)]}async getRequestInit(e="GET",t){const s=await h(this.options.remoteApi.GET_Headers),a=await(this.options.remoteApi.authToken?.());return{method:e,body:t,...s,...a?{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",...s?.headers}}:{}}}}"chrome-extension:"!==self.location.protocol?browser.storage.session={get:e=>browser.runtime.sendMessage({type:"_session_store_get",key:e}),set:e=>browser.runtime.sendMessage({type:"_session_store_set",items:e}),remove:e=>browser.runtime.sendMessage({type:"_session_store_remove",key:e}),clear:()=>Promise.resolve(),onChanged:{addListener:()=>({removeListener:()=>{}}),removeListener:()=>({removeListener:()=>{}}),hasListener:()=>!1}}:a&&browser.runtime.onMessage.addListener((e=>{switch(e.type){case"_session_store_get":return browser.storage.session.get(e.key);case"_session_store_set":return browser.storage.session.set(e.items);case"_session_store_remove":return browser.storage.session.remove(e.key)}}));const S=new k("__install_date",(()=>{}),{storageArea:"sync"});browser.runtime.onInstalled.addListener((async({reason:e})=>{if("install"===e){const e=await S.get();Array.isArray(e)||await S.set([i(),i()])}}));let I=!1;const T=Promise.resolve(!1);let O=!1;T.then((e=>O=!1));async function v(){const[e]=await browser.tabs.query(I?{active:!0}:{active:!0,lastFocusedWindow:!0});return e}async function D(e,t={}){const s=(r=e,Array.isArray(r)?r:[r]);var r;const{cookieStoreId:i,inNewTab:n=!1,nextToCurrent:o=!1,active:c=!1,inNewWindow:l=!1,windowId:h,windowOptions:u={},forceIncognitoWindow:f=!1,stopOpenerTabId:g,_directCall:d}=t,w=l||f;if(!a&&!d)return function(e,t){if(t._directCall)throw Error("infinite loop???");return t._directCall=!0,browser.runtime.sendMessage(new L(e,t))}(s,t);const m={},[p,...b]=s,y=await _(p,0,h);return b.forEach(((e,t)=>_(e,t+1,y.windowId))),y;async function _(e,t,s){if(w)return browser.windows.create({url:e,...u,...m,...f?{incognito:!0}:{}}).then((e=>e?.tabs[0]));if(n||t>0){const r=c&&0===t,i=await v()||{id:void 0,index:void 0},n=(a=i.index,Number.isFinite(a)?i.index+1:void 0),l=!(!I&&!g),h=t=>browser.tabs.create({url:e,...m,windowId:s,active:r,...o?{index:n}:{},...t?{}:{openerTabId:i.id}});return l?await h(l):await h(l).catch((()=>h(!0)))}return await browser.tabs.update({url:e});var a}}class L{links;options;type;constructor(e,t){this.links=e,this.options=t,this.type="openURL"}}a&&browser.runtime.onMessage.addListener((e=>{if("openURL"===e.type)return D(e.links,e.options)}));const E="_ext_started",x=(async()=>{if(!a)return!1;const{[E]:e}=await browser.storage.session.get(E);return!e&&(await browser.storage.session.set({[E]:Date.now()}),!0)})(),P=new Promise((e=>x.then((t=>t&&e()))));const[N,C]=g(),M=(Promise.resolve(),(e,t)=>e?browser.i18n.getMessage(e,t):"");new Map;function B(e,t){return function(e){const t=Object.getOwnPropertyNames(e);for(let s=0;s<t.length;s++)delete e[t[s]]}(e),Object.assign(e,t)}const j=new k("options",(()=>{})),V={FONT_SIZE:18,SIDE_BAR_SIZE:256,DEFAULT_BACKGROUND_COLOR:"#FFFF00FF",DEFAULT_TEXT_COLOR:"#7c0000",DEFAULT_LIST_ON:!0,EXCLUDED_DOMAINS:[],LIST_POSITION:"right",LIST_WIDTH:20,LIST_ITEM_HEIGHT:2,STORAGE_AREA:_.sync},F=async function(e,t){const s=e.storageArea;_[s]&&browser.storage[s].onChanged.addListener((s=>{s[e.key]&&B(t,s[e.key].newValue||{})}));const a=await e.get();return a?(Object.entries(t).filter((([e])=>!a.hasOwnProperty(e))).map((([e,t])=>a[e]=t)).length>0&&await e.set(a),B(t,a||{})):(await e.set(t),t)}(j,V),W=(new k("last_rule_id",(()=>0)),new k("last_selection",(()=>({selection:"",isTemp:!1,allPages:!1,tabId:0})),{storageArea:"session"})),U="_rule_";function $({areaName:e,filter:t,callback:s}){return(a,r)=>{if(e&&e!==r)return;const i=function(e,{filter:t}={}){return Object.fromEntries(Object.entries(e).filter((([e,s])=>!t||t(e,s))).map((([e,t])=>[e,t?.newValue])))}(a,{filter:t});s(i)}}var J;(e=>{e[e.DOMAIN=0]="DOMAIN",e[e.URL=1]="URL",e[e.CONTAINS=2]="CONTAINS",e[e.REGEX=3]="REGEX",e[e.ALL=4]="ALL"})(J||(J={}));function G(e,t=!1){try{const s=new URL(e).hostname;return t&&s.startsWith("www.")?s.substring(4):s}catch(e){return""}}function z(e,t){if(null==e||null==t)return e===t;if(e.constructor!==t.constructor)return!1;if(e instanceof Function)return e===t;if(e instanceof RegExp)return e===t;if(e===t||e.valueOf()===t.valueOf())return!0;if(Array.isArray(e)&&e.length!==t.length)return!1;if(e instanceof Date)return!1;if(!(e instanceof Object&&t instanceof Object))return!1;const s=Object.keys(e);return Object.keys(t).every((e=>-1!==s.indexOf(e)))&&s.every((s=>z(e[s],t[s])))}s(555);const H=e=>browser.runtime.sendMessage(e),q=async(e,t,s)=>browser.tabs.sendMessage(e,t,s);new Set(["svg","path","circle","text"]);const X=n;class Y{pageURL;id;disabled;matchesList;temp;name;text;note;matchPages;search;style;_order;_isActive;_isNew;_tabId;_changeBackground;_changeTextColor;_changeFontSize;beingRenamed;newName;hasNote;constructor(e,t,s,a){this.pageURL=t,this.id=u(),this.disabled=!1,this.matchesList=!1,this.temp=!1,this.name="",this.text="",this.matchPages=[],this.search={},this.style={},this._isActive=!1,this._isNew=!1,this._tabId=0,this.beingRenamed=!1,this.newName="",c(e)?(this.text=e,this.temp=!!s,this.matchPages=[{matchType:a?J.ALL:J.DOMAIN,matchValue:G(t,!0)}],this.style={background:V.DEFAULT_BACKGROUND_COLOR},this.search={acrossElements:!0,eachWord:!!this.text&&!this.text.includes(" ")},this.matchesList=!!V.DEFAULT_LIST_ON):Object.assign(this,e),this.note??="",this.hasNote=!!this.note,this._order=this.id,this._changeBackground=!!this.style.background,this._changeTextColor=!!this.style.color,this._changeFontSize=l(this.style.size)}duplicateRule(){const e=this.serializeRule();return e.id=u(),new Y(e)}get label(){return this.name||this.text||M("empty rule")}get createDateLabel(){return function(e=Date.now()){const t=new Date(e);return`${t.toLocaleDateString()} ${t.toLocaleTimeString()}`}(this.id)}get isInvalid(){return!(this.text&&this.matchPages.some((e=>e.matchType===J.ALL||e.matchValue)))}get isValid(){return!this.isInvalid}get icon(){return this.disabled?"fa-eye-slash":this.isInvalid?"fa-exclamation-circle":this._isActive?"fa-check-circle":this.temp?"far fa-clock":""}get title(){return this.disabled?M("disabled_rule"):this.isInvalid?M("incomplete_rule"):this._isActive?M("active_on_current_page"):this.temp?M("temporal_rule_helper"):""}get detailsTitle(){return`${this.label}\n${this.note?`${M("label_note")} ${this.note}\n`:""}\n${M("active_on_pages")}\n\t${this.matchPages.map((e=>e.matchValue)).join("\n\t")}`}serializeRule(){this.matchPages.forEach((e=>{if(e.matchType===J.DOMAIN){const t=G(e.matchValue);t&&(e.matchValue=t)}else e.matchType===J.ALL&&(e.matchValue="")})),this._changeBackground||delete this.style.background,this._changeTextColor||delete this.style.color,this._changeFontSize||delete this.style.size,function(e,...t){const s=new Set(t);Object.keys(e).forEach((t=>{s.has(t)||e[t]||delete e[t]}))}(this.style,"size");const e={id:this.id,name:this.name,...this.note?{note:this.note}:{},matchesList:this.matchesList,disabled:this.disabled,temp:this.temp,text:this.text,matchPages:this.matchPages,search:this.search,style:this.style};return t=e,JSON.parse(JSON.stringify(t));var t}async saveRule(){const e=this.serializeRule();await K.saveRule(e)}async deleteRule(e=!1){X("deleting rule",this),e&&await H({type:"createBackup",backupName:M("save_before_remove",[this.label,this.text])}).catch(n),await K.deleteRule(this.id)}compareDomains(e){if(!e)return!1;const t=e=>e.map((e=>`${e.matchType};${e.matchValue}`)).sort().join("");return t(this.matchPages)===t(e.matchPages)}startRenaming(){this.beingRenamed=!0,this.newName=this.label}stopRenaming(){this.beingRenamed=!1}async renameRule(e){this.stopRenaming();const t=e||this.name;this.name!==t&&(this.name=t,await this.saveRule())}static async getActiveRules(e){return new Set(await q(e,{type:"get_active_rules"},{frameId:0}).catch((()=>[])))}}const K=new class{promise=F.then((()=>{}));dataSyncOrder=new k("order",(()=>[]),{storageArea:"sync"});dataLocalOrder=new k("order",(()=>[]),{storageArea:"local"});get DATA_ORDER(){return V.STORAGE_AREA===_.local?this.dataLocalOrder:this.dataSyncOrder}get storeArea(){return V.STORAGE_AREA}async changeStoreArea(e){const t=e===_.local?_.sync:_.local,s=await browser.storage[t].get();delete s[j.key],await this.deleteAllRules(),await browser.storage[e].set(s)}async getRules(){return await this.promise,browser.storage[this.storeArea].get().then((e=>this.extractStoredRules(e)))}async deleteAllRules(){const e=(await this.getRules()).map((e=>U+e.id));await browser.storage[this.storeArea].remove(e)}async getRule(e){return await this.promise,browser.storage[this.storeArea].get(U+e).then((({[U+e]:t})=>new Y(t)))}extractStoredRules(e){return Object.entries(e).filter((([e])=>e.startsWith(U))).map((([e,t])=>new Y(t)))}async saveRule(e){await this.promise,await browser.storage[this.storeArea].set({[U+e.id]:e}),H({type:"reloadRules"})}async deleteRule(e){await this.promise,await browser.storage[this.storeArea].remove(U+e)}};async function Z(e){return function(e,t,s){const a=((e,t)=>{const s={};if(!e)return s;for(let a=0;a<e.length;a++){const r=e[a];s[r[t]]=r}return s})(e,t);return s.map((e=>{const t=a[e];return delete a[e],t})).filter(f).concat(Object.values(a))}(e,"id",await K.DATA_ORDER.get())}function Q(e){return t=`/editor/editor.html#${s=e,encodeURIComponent(JSON.stringify(s))}`,r&&!browser?.runtime?t:browser.runtime.getURL(t);var t,s}function ee(e,t){if(null!=e)return t(e)}const te=()=>["/browser-polyfill.min.js"];class se{selection;url;allPages;isTemp;tabId;editorURL;constructor(e,t,s,a,r){this.selection=e,this.url=t,this.allPages=s,this.isTemp=a,this.tabId=r,this.editorURL=Q({selection:e,url:t,allPages:s,isTemp:a,tabId:r})}async openInNewTab(){return D(this.editorURL,{active:!0,inNewTab:!0,nextToCurrent:!0})}async openInNewWindow(){await browser.windows.create({url:this.editorURL,type:"popup",state:"normal",width:900,height:600})}async injectToTab(e,t){await browser.scripting.executeScript({target:{tabId:e,frameIds:ee(t,(e=>[e]))},files:[...te(),"/content_scripts/build_highlighter.js"]})}}if(browser.contextMenus){const e=function(e,t,{maximumDelay:s=0}={}){let a=-1,r=-1,i=n;function o(){a>0&&self.clearTimeout(a),s&&r>0&&self.clearTimeout(r),a=r=-1,i=n}return c.flush=()=>i(),c.cancel=()=>(-1!==a||-1!==r)&&(o(),!0),c;function c(n=t,c=e){if(self.clearTimeout(a),a=-1,!1===c)return;const l=i=()=>{o(),n()};a=self.setTimeout(l,c),s&&r<0&&(r=self.setTimeout(l,s))}}(1e3,ae);browser.storage.onChanged.addListener($({filter:e=>e.startsWith(U)||e===K.DATA_ORDER.key||e===j.key,callback:()=>e()})),browser.runtime.onInstalled.addListener(ae),browser.runtime.onStartup.addListener(ae)}async function ae(){await F;const e=[...["selection_highlight","selection_temp","selection_temp_everywhere","add_to_rule"].map((e=>re(e,M(e,'"%s"'),["selection"],`DISABLE_CM_${e.toUpperCase()}`))),re("page_highlight",M("page_highlight"),["page"],"DISABLE_CM_PAGE")];await browser.contextMenus.removeAll();const t=await Z((await K.getRules()).filter((e=>!e.disabled&&e.isValid)));async function s(e,t){for(const s of t)await browser.contextMenus.create({id:`generated_${e.id}_${s.id}`,title:s.label,contexts:e.contexts,parentId:e.id})}await async function(e,{beforeEach:t=n,afterEach:s=n,ignoreExceptions:a=!1}={}){const r=Array(e.length);for(let i=0;i<e.length;i++){await t(i);const n=e[i],o=await(a?n().then((e=>[e])).catch((e=>[void 0,e||"unknown GSD error"])):n().then((e=>[e])));r[i]=o,await s(i,o)}return r}(e.map((e=>async()=>{if(await e.build())switch(e.id){case"page_highlight":await s(e,t);break;case"add_to_rule":await s(e,t.filter((e=>e.search.eachWord)))}})))}function re(e,t,s,a){return{id:e,optionName:a,contexts:s,build:async(r,i,n)=>!(await F)[a]&&(browser.contextMenus.create({id:r||e,parentId:n,title:i||t,contexts:s}),!0)}}async function ie(e){await browser.scripting.executeScript({target:{tabId:e,allFrames:!0},func:()=>self.getSelection()?.removeAllRanges()}).catch(n)}function ne(e,t){const s={},a={},r=c(t);for(let i=0;i<e.length;i++){const n=e[i],o=r?n[r]:t(n);s[o]?a[o].push(n):(a[o]=[n],s[o]=!0)}return a}browser.contextMenus?.onClicked.addListener((async({menuItemId:e,selectionText:t,frameId:s},a)=>{if(!a)throw Error("missing tab data");const r=t?.trim()||"",i=a.id;switch(e){case"add_to_rule":case"page_highlight":break;case"selection_highlight":case"selection_temp":case"selection_temp_everywhere":{const t="selection_temp_everywhere"===e,n=e.includes("_temp");W.set({selection:r,allPages:t,isTemp:n,tabId:i});try{const e="action";await browser[e].openPopup()}catch(e){const o=new se(r,a.url,t,n,i);await o.injectToTab(i,s)}await ie(i);break}default:{const t=String(e);if(t.startsWith("generated_")){const[e]=t.split("_").slice(-1).map((e=>parseInt(e))),s=await K.getRule(e);if(t.startsWith("generated_page_highlight_"))!function(e,t,s){for(let a=0;a<e.length;a++)if(s(e[a],t))return e;e.push(t)}(s.matchPages,{matchType:J.DOMAIN,matchValue:G(a.url,!0)},z),await s.saveRule(),await async function(e){await browser.scripting.executeScript({target:{tabId:e,allFrames:!0},files:["/content_scripts/page_loaded.js"]})}(i);else if(t.startsWith("generated_add_to_rule_")&&r){const e=new Set(s.text.split(" ").concat(r));s.text=[...e.values()].join(" "),await s.saveRule()}await ie(i)}}}})),P.then((async()=>{const e=await K.getRules();for(const t of e)t.temp&&await t.deleteRule()})),browser.commands?.onCommand?.addListener((async e=>{"toggle-highlight"===e&&async function(e,t,{onEnabled:s=n,onDisabled:a=n,storageArea:r="local"}){if(!t)throw Error("no name");const i=e[t]=!e[t];await browser.storage[r].set({options:e}),i?s():a()}(V,"IS_DISABLED",{})}));const oe={},ce={},le=[],he=[],ue=[];browser.storage.onChanged.addListener($({filter:e=>e.startsWith(U),callback:async e=>{await de()}}));const fe=de();async function ge(e){await fe,await F;const t=G(e,!0);if(V.EXCLUDED_DOMAINS.includes(t))return[];const s=new Set;oe[e]&&oe[e].forEach((e=>s.add(e))),ce[t]&&ce[t].forEach((e=>s.add(e)));for(let t=0;t<le.length;t++){const a=le[t];e.includes(a.matchPages[0].matchValue)&&s.add(a)}for(let t=0;t<he.length;t++){const a=he[t];e.match(a.matchPages[0].matchValue)&&s.add(a)}return ue.forEach((e=>s.add(e))),Array.from(s)}async function de(){const e=(await K.getRules()).flatMap((e=>e.matchPages.map((t=>Object.assign({},e,{matchPages:[t]}))))).filter((e=>e.matchPages[0].matchType===J.ALL||e.matchPages[0].matchValue));B(ce,ne(e.filter((e=>e.matchPages[0].matchType===J.DOMAIN)),(e=>e.matchPages[0].matchValue))),B(oe,ne(e.filter((e=>e.matchPages[0].matchType===J.URL)),(e=>e.matchPages[0].matchValue))),le.length=0,he.length=0,ue.length=0;for(let t=0;t<e.length;t++){const s=e[t];switch(s.matchPages[0].matchType){case J.ALL:ue.push(s);break;case J.CONTAINS:le.push(s);break;case J.REGEX:try{new RegExp(s.matchPages[0].matchValue),he.push(s)}catch(e){}}}}async function we(e,t,s){const a=await ge(s);0!==a.length&&(await async function(e,t){if(await q(e,{type:"ping"},{frameId:t}).catch((()=>!1)))return;const s=await browser.scripting.executeScript({target:{tabId:e,frameIds:ee(t,(e=>[e]))},files:[...te(),"/content_scripts/auto_highlight_cs.js"]});s.filter((e=>e.error)).forEach(console.error)}(e,t),await q(e,{type:"rules",rules:a},{frameId:t}))}function me(){const e=browser.runtime.getManifest();return`${e.name} ${e.version}`}const pe="action";async function be(e,t,s,a){t||e&&(V.DISABLE_BADGE||async function(e,t){await(browser[pe].setBadgeText?.({tabId:e,text:t?t.toString():""}))}(e,s),browser[pe].setTitle?.({tabId:e,title:`${me()}${s?`\n${M("matches_count")}: ${s}\n\n${a}`:""}`}))}var ye,_e;browser[pe].setBadgeBackgroundColor?.({color:"#ff6000"}),j.addOnChangeListener((async({newValue:e})=>{if(e?.DISABLE_BADGE){(await browser.tabs.query({})).forEach((e=>browser[pe].setBadgeText?.({tabId:e.id,text:""})))}})),(e=>{e.DB_OP_READ_WRITE="readwrite",e.DB_OP_READONLY="readonly"})(ye||(ye={})),(e=>{e.DB_HISTORY="history"})(_e||(_e={}));const Ae=(()=>{const e=new Promise(((e,t)=>{const s=self.indexedDB.open("auto_highlight",1);s.onupgradeneeded=e=>{const a=s.result;a.onerror=a.onabort=e=>t(e),a.objectStoreNames.contains("history")||a.createObjectStore("history",{keyPath:"id",autoIncrement:!1})},s.onerror=e=>t(e),s.onsuccess=()=>{e(s.result)}}));return{promise:e,dbTransactionOperation:async function(e,a,r,...i){return s(await t(e,a),r,...i)},dbTransaction:t,dbOperation:s};async function t(t,s){const a=(await e).transaction([t],s);return a.onerror=a.onabort=e=>{},a.objectStore(t)}async function s(e,t,...s){return new Promise(((a,r)=>{const i=e[t].apply(e,s);i.onerror=e=>{r()},i.onsuccess=()=>{a(i.result)}}))}})();class Re{name;callback;constructor(e,t){this.name=e,this.callback=t,t&&this.addListener(t)}create(e){browser.alarms.create(this.name,e)}createOnStart(e){P.then((()=>this.create(e)))}clear(){return browser.alarms.clear(this.name)}addListener(e){m(),browser.alarms.onAlarm.addListener((t=>t.name===this.name&&e(t)))}now(){this.create({when:Date.now()})}}const ke=new class{MAX_HISTORY_COUNT=64;delayedSave=new Re("delayed_save",(()=>this.backupData()));constructor(){m(),browser.runtime.onStartup.addListener((()=>this.clearOldHistory())),browser.storage.onChanged.addListener(((e,t)=>{t!==_.session&&this.delayedSave.create({delayInMinutes:1})}))}async backupData(e="auto-backup"){this.delayedSave.clear();const t=await browser.storage[K.storeArea].get(),s={id:u(),name:e,data:t};await Ae.dbTransactionOperation(_e.DB_HISTORY,ye.DB_OP_READ_WRITE,"put",s)}async getBackups(){return(await Ae.dbTransactionOperation(_e.DB_HISTORY,ye.DB_OP_READONLY,"getAll")).reverse()}async clearOldHistory(){const e=await Ae.dbTransaction(_e.DB_HISTORY,ye.DB_OP_READ_WRITE),t=await Ae.dbOperation(e,"getAll"),s=t.length-this.MAX_HISTORY_COUNT;for(let a=0;a<s;a++)await Ae.dbOperation(e,"delete",t[a].id)}};new k("rate.extension",(()=>({state:"new"})),{storageArea:"local"});browser.runtime.onInstalled.addListener((async({reason:e,previousVersion:t})=>{0})),browser.runtime.onMessage.addListener(((e,t)=>{switch(e.type){case"page_loaded":we(t.tab.id,t.frameId,e.url);break;case"getRulesInTab":return v().then((e=>ge(e.url)));case"createBackup":return ke.backupData(e.backupName);case"getBackups":return ke.getBackups();case"matches_count":be(t.tab?.id,t.frameId,e.matchesCount,e.statInfo);break;case"selfMessage":return t.tab?.id?q(t.tab.id,e.message):H(e.message);case"isRunningInTab":return Promise.resolve(!!t.tab);case"forward_to_current_tab":return v().then((({id:t})=>q(t,e.message)));case"broadcast":return browser.runtime.sendMessage(e.broadcastMessage)}})),async function(){browser.runtime.onUpdateAvailable.addListener((async e=>{})),await F}()}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,s),i.exports}(()=>{"use strict";s(24)})()})();