# Auto Highlight 扩展 - 最终修复说明

## ✅ 问题已完全解决！

### 问题描述

当输入多行关键字时（每行一个），扩展无法正常高亮。例如：
```
蓝色
绿色
```

只有第一行能高亮，添加第二行后所有高亮都失效。

### 根本原因

扩展的逻辑是：
1. 当文本包含换行符 `\n` 时，设置 `eachWord = false`
2. `eachWord = false` 时，扩展会把整个多行文本当作**一个完整的关键字**来匹配
3. 所以 `"蓝色\n绿色"` 被当作一个整体去匹配，而不是分别匹配 "蓝色" 和 "绿色"

### 解决方案

在 `background/background_ah.js` 中添加一个函数 `splitRulesByNewline()`，在发送规则给 content script 之前，将包含换行符的规则分割成多个独立的规则。

## 📝 修改的文件

### 1. `editor/editor.js`

**修改内容**：移除数据转换，直接保存换行符

**原始代码**：
```javascript
model:{value:e.rule.text.replace(/ +/g,"\n")}  // 显示时转换
this.rule.text=this.rule.text.replace(/\n+/g," ")  // 保存时转换
```

**修改后**：
```javascript
model:{value:e.rule.text}  // 直接显示
this.rule.text=this.rule.text  // 直接保存
```

### 2. `background/background_ah.js`

**修改 1**：将关键字分割从空格改为换行符

```javascript
// 原始：
s.text.split(" ").concat(r)
eachWord:!!this.text&&!this.text.includes(" ")

// 修改后：
s.text.split("\n").concat(r)
eachWord:!!this.text&&!this.text.includes("\n")
```

**修改 2**：添加规则分割函数

在 `async function ue(e)` 之前添加：

```javascript
function splitRulesByNewline(rules){
    const result=[];
    for(const rule of rules){
        if(rule.text&&rule.text.includes("\n")){
            // 按换行符分割
            const keywords=rule.text.split("\n").filter(k=>k.trim());
            for(const keyword of keywords){
                result.push({
                    ...rule,
                    text:keyword,
                    search:{...rule.search,eachWord:true}
                })
            }
        }else{
            result.push(rule)
        }
    }
    return result
}
```

并修改 `ue` 函数的返回语句：

```javascript
// 原始：
return le.forEach((e=>s.add(e))),Array.from(s)

// 修改后：
return le.forEach((e=>s.add(e))),splitRulesByNewline(Array.from(s))
```

### 3. `content_scripts/auto_highlight_cs.js` ⭐ 最关键的修改！

**修改内容**：将 Mark.js 库的关键字分割从空格改为换行符

**原始代码**：
```javascript
getSeachTerms(t){
    ...
    o=t=>{t.split(/ +/).forEach((t=>n(t)))},  // 用空格分割
    ...
}
```

**修改后**：
```javascript
getSeachTerms(t){
    ...
    o=t=>{t.split(/\n+/).forEach((t=>n(t)))},  // 用换行符分割
    ...
}
```

**这是核心修改！** 这个修改让 Mark.js 库按换行符而不是空格来分割关键字。

## 🎯 工作原理

1. **用户输入**：在编辑器中每行输入一个关键字
   ```
   蓝色
   绿色
   ```

2. **存储**：关键字以换行符 `\n` 分隔存储
   ```
   "蓝色\n绿色"
   ```

3. **规则获取**：当页面加载时，`ue()` 函数获取匹配的规则

4. **规则分割**：`splitRulesByNewline()` 检测到规则包含 `\n`，将其分割成多个独立规则
   ```javascript
   [
     { text: "蓝色", search: { eachWord: true } },
     { text: "绿色", search: { eachWord: true } }
   ]
   ```

5. **高亮处理**：每个关键字作为独立规则发送给 content script 进行高亮

## 📋 使用说明

### 输入关键字

现在每行输入一个关键字：

```
11
[251031] 【DMM】 [SURVIVE MORE] アイドル級に可愛い世間知らずの箱入り娘と周囲に内緒いちゃらぶ関係になり毎日毎晩ヤリまくる話 The Motion Anime
33
44
```

### 重新加载扩展

修改完成后，必须重新加载扩展：

1. 打开 `chrome://extensions/` 或 `edge://extensions/`
2. 找到 "Auto Highlight" 扩展
3. 点击 **刷新/重新加载** 按钮 🔄

### 测试

1. 打开扩展编辑器
2. 输入测试关键字（每行一个）
3. 保存
4. 访问包含这些关键字的网页
5. 验证高亮是否正常工作

## ✨ 特性

- ✅ 每行一个关键字
- ✅ 关键字内可以包含空格
- ✅ 支持超长关键字（如日文标题）
- ✅ 自动过滤空行
- ✅ 每个关键字独立高亮

## 🔧 技术细节

### 关键代码位置

**editor.js**（第 1 行，压缩后）：
- 搜索：`model:{value:e.rule.text`
- 搜索：`this.rule.text=`

**background_ah.js**（第 1 行，压缩后）：
- 搜索：`split(" ")` → 改为 `split("\n")`
- 搜索：`includes(" ")` → 改为 `includes("\n")`
- 搜索：`async function ue(e)` → 在前面添加 `splitRulesByNewline` 函数
- 搜索：`Array.from(s)` → 改为 `splitRulesByNewline(Array.from(s))`

### 数据流

```
用户输入
  ↓
存储（包含 \n）
  ↓
读取规则
  ↓
splitRulesByNewline() 分割
  ↓
发送给 content script
  ↓
高亮显示
```

## 📅 修改历史

- **2024-11-04**：最终修复完成，添加 `splitRulesByNewline()` 函数，完美支持换行分隔关键字

## 🎉 完成！

现在扩展可以完美支持：
- 每行一个关键字
- 关键字内包含空格
- 超长关键字（如：`[251031] 【DMM】 [SURVIVE MORE] アイドル級に可愛い世間知らずの箱入り娘と周囲に内緒いちゃらぶ関係になり毎日毎晩ヤリまくる話 The Motion Anime`）

享受你的魔改扩展吧！😊

